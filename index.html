<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronogramas</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Crect width='48' height='48' rx='12' fill='%23007AFF'/%3E%3Cpath d='M14 16h20v3H14zM14 22.5h20v3H14zM14 29h14v3H14z' fill='white'/%3E%3C/svg%3E">

    <style>
        /* ============================================================
   DESIGN SYSTEM ‚Äî Apple-inspired clean & minimal
   ============================================================ */

        /* SF Pro Display n√£o existe no Google Fonts ‚Äî usando stack nativa do sistema Apple/Windows/Linux */

        :root {
            /* Colors */
            --blue: #007AFF;
            --blue-dark: #0062CC;
            --green: #34C759;
            --red: #FF3B30;
            --orange: #FF9500;
            --purple: #AF52DE;
            --teal: #5AC8FA;

            --bg: #F2F2F7;
            --surface: #FFFFFF;
            --surface2: #F9F9FB;
            --border: rgba(0, 0, 0, 0.08);
            --separator: rgba(0, 0, 0, 0.06);

            --text-primary: #1C1C1E;
            --text-secondary: #636366;
            --text-tertiary: #AEAEB2;

            /* Spacing */
            --r-sm: 8px;
            --r-md: 12px;
            --r-lg: 16px;
            --r-xl: 20px;
            --r-2xl: 28px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.06);

            /* Transitions */
            --t-fast: 0.15s ease;
            --t-med: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --t-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);

            /* Font */
            --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }

        /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            min-height: 100vh;
            font-family: var(--font);
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        body {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 16px 120px;
        }

        /* ‚îÄ‚îÄ Typography ‚îÄ‚îÄ */
        h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            text-align: center;
            padding: 32px 0 0;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        /* ‚îÄ‚îÄ Form elements ‚îÄ‚îÄ */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--r-md);
            font-size: 16px;
            font-family: var(--font);
            color: var(--text-primary);
            background: var(--surface);
            outline: none;
            transition: border-color var(--t-fast), box-shadow var(--t-fast);
            /* -webkit-appearance: none; */
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        /* ‚îÄ‚îÄ Base button ‚îÄ‚îÄ */
        button {
            font-family: var(--font);
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            border-radius: var(--r-md);
            padding: 10px 18px;
            transition: all var(--t-fast);
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            transform: scale(0.97);
        }

        /* Button variants */
        .btn-primary {
            background: var(--blue);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--blue-dark);
        }

        .btn-success {
            background: var(--green);
            color: #fff;
        }

        .btn-success:hover {
            filter: brightness(0.92);
        }

        .btn-danger {
            background: var(--red);
            color: #fff;
        }

        .btn-danger:hover {
            filter: brightness(0.92);
        }

        .btn-ghost {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: rgba(0, 0, 0, 0.09);
        }

        .btn-icon {
            background: var(--surface);
            color: var(--text-primary);
            border: 1.5px solid var(--border);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--r-md);
            padding: 0;
            font-size: 16px;
            box-shadow: var(--shadow-sm);
        }

        .btn-icon:hover {
            border-color: var(--blue);
            color: var(--blue);
        }


        /* ‚îÄ‚îÄ Card / Surface ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border-radius: var(--r-xl);
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ Top form (hidden by default) ‚îÄ‚îÄ */
        .container {
            display: none;
            margin-top: 16px;
            background: var(--surface);
            border-radius: var(--r-xl);
            padding: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            animation: slideDown var(--t-med);
        }

        .form-group {
            margin-bottom: 16px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‚îÄ‚îÄ Marker buttons row ‚îÄ‚îÄ */
        .marker-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ Indent help ‚îÄ‚îÄ */
        .indent-help {
            margin-top: 8px;
            padding: 10px 14px;
            background: var(--surface2);
            border-radius: var(--r-md);
            font-size: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ Camera section ‚îÄ‚îÄ */
        .camera-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 6px;
        }

        .camera-btn,
        .gallery-btn {
            padding: 10px 16px;
            border-radius: var(--r-md);
            background: var(--green);
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            border: none;
        }

        .camera-btn:hover,
        .gallery-btn:hover {
            filter: brightness(0.9);
        }

        .image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 8px 0;
        }

        .image-preview img {
            max-width: 120px;
            max-height: 90px;
            border-radius: var(--r-md);
            border: 1.5px solid var(--border);
            object-fit: cover;
        }

        .captured-image {
            position: relative;
            display: inline-block;
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--red);
            color: #fff;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
        }

        /* ‚îÄ‚îÄ Button row inside form ‚îÄ‚îÄ */
        .ocultareinicia {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: nowrap;
        }

        #toggleContainerBtn {
            display: none;
            padding: 10px 18px;
            background: rgba(255, 59, 48, 0.12);
            color: var(--red);
            border: 1.5px solid rgba(255, 59, 48, 0.2);
        }

        #toggleContainerBtn:hover {
            background: var(--red);
            color: #fff;
        }

        #resetGuideBtn {
            display: none;
            padding: 10px 18px;
            background: rgba(0, 122, 255, 0.08);
            color: var(--blue);
            border: 1.5px solid rgba(0, 122, 255, 0.2);
        }

        #resetGuideBtn:hover {
            background: var(--blue);
            color: #fff;
        }

        #adicionarmanual {
            padding: 11px 22px;
            background: var(--green);
            color: #fff;
        }

        /* ‚îÄ‚îÄ Toolbar: search + controls ‚îÄ‚îÄ */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            /* margin-top: 20px; */
            flex-wrap: wrap;
        }

        .search-wrap {
            flex: 1;
            position: relative;
            min-width: 200px;
        }

        .search-wrap svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        #searchInput {
            padding-left: 38px;
            padding-right: 36px;
            border-radius: 100px;
            font-size: 15px;
            margin: 0;
        }

        #clearSearchBtn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            display: none;
            padding: 4px;
            width: auto;
            height: auto;
            box-shadow: none;
        }

        #clearSearchBtn:hover {
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ Pagination + view mode ‚îÄ‚îÄ */
        .meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pagination-controls button {
            background: var(--surface);
            color: var(--text-primary);
            border: 1.5px solid var(--border);
            padding: 6px 12px;
            border-radius: var(--r-md);
            font-size: 13px;
            box-shadow: var(--shadow-sm);
        }

        .pagination-controls button:hover:not(:disabled) {
            border-color: var(--blue);
            color: var(--blue);
        }

        .pagination-controls button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        #pageInfo {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        #pageSizeSelect {
            padding: 6px 10px;
            border-radius: var(--r-md);
            font-size: 13px;
            width: auto;
            border: 1.5px solid var(--border);
            background: var(--surface);
        }

        #viewModeSelect {
            padding: 6px 10px;
            border-radius: var(--r-md);
            font-size: 13px;
            width: auto;
            background: var(--surface);
            border: 1.5px solid var(--border);
            color: var(--text-secondary);
        }

        /* ‚îÄ‚îÄ Task list ‚îÄ‚îÄ */
        .task-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ‚îÄ‚îÄ Task item ‚îÄ‚îÄ */
        .task-item {
            background: var(--surface);
            border-radius: var(--r-xl);
            border: 1.5px solid var(--border);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow var(--t-med), border-color var(--t-med), transform var(--t-med);
        }

        .task-item.expanded {
            box-shadow: var(--shadow-lg);
            border-color: rgba(0, 122, 255, 0.3);
            transform: scale(1.005);
        }

        .task-item.completed {
            opacity: 0.55;
        }

        .task-content {
            padding: 0;
        }

        /* Task header row */
        .task-header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .task-header:hover {
            background: rgba(0, 0, 0, 0.015);
        }

        .task-name {
            font-style: italic;
            padding: 5px 15px 0px 20px;
            flex: 1;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Task actions */
        .task-actions {
            padding: 5px;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .task-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: var(--r-md);
        }

        /* Progress bar */
        .task-progress {
            height: 3px;
            background: var(--separator);
            margin: 0 16px 1px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--green);
            border-radius: 2px;
            transition: width var(--t-slow);
        }

        /* Expand button */
        .expand-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 0 16px 12px;
            padding: 7px 14px;
            background: rgba(0, 122, 255, 0.08);
            color: var(--blue);
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--t-fast);
        }

        .expand-btn:hover {
            background: rgba(0, 122, 255, 0.14);
        }

        .expand-btn .expand-icon {
            font-size: 10px;
            transition: transform var(--t-med);
        }

        .expand-btn.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* ‚îÄ‚îÄ Local search inside task ‚îÄ‚îÄ */
        .task-local-search {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 8px 16px;
            border-top: 1px solid var(--separator);
            background: var(--surface2);
        }

        .task-local-search input {
            flex: 1;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: var(--r-md);
            margin: 0;
        }

        .task-local-search button {
            padding: 7px 11px;
            font-size: 13px;
            border-radius: var(--r-md);
        }

        .task-item.collapsed .task-local-search {
            display: none;
        }

        /* small nav buttons */
        .ant,
        .prox {
            background: var(--blue);
            color: #fff;
            border-radius: var(--r-md);
            padding: 7px 11px;
        }

        .cuqui {
            background: rgba(255, 59, 48, 0.1);
            color: var(--red);
            border-radius: var(--r-md);
            padding: 7px 11px;
        }

        .cuqui0 {
            flex: 1;
        }

        .searchvoice {
            background: var(--purple);
            color: #fff;
            border-radius: var(--r-md);
            padding: 7px 11px;
            font-size: 14px;
        }

        .search-counter {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Steps ‚îÄ‚îÄ */
        .task-steps-wrapper {
            width: 100%;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--blue) transparent;
        }

        .task-steps-wrapper::-webkit-scrollbar {
            height: 6px;
        }

        .task-steps-wrapper::-webkit-scrollbar-thumb {
            background: rgba(0, 122, 255, 0.3);
            border-radius: 3px;
        }

        .task-steps {
            min-height: 153px;
            max-height: 344px;
            overflow-y: auto;
            padding: 8px 16px 12px;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
        }

        .task-steps::-webkit-scrollbar {
            width: 4px;
        }

        .task-steps::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 2px;
        }

        .task-steps.collapsed {
            display: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‚îÄ‚îÄ Individual step ‚îÄ‚îÄ */
        .task-step {
            clip-path: content-box;
            display: flex;
            align-items: center;
            padding: 7px 10px;
            margin-bottom: 4px;
            border-radius: var(--r-md);
            cursor: pointer;
            transition: background var(--t-fast);
            position: relative;
            white-space: nowrap;
            width: max-content;
            animation: slideIn 0.2s ease;
        }

        .task-step:hover {
            background: rgba(0, 122, 255, 0.06);
        }

        .task-step.completed {
            background: rgba(52, 199, 89, 0.08);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-step.step-focus {
            background: rgba(255, 204, 0, 0.2);
            border-left: 3px solid #FFCC00;
        }

        /* Level colors */
        .task-step[data-level="0"],
        .task-step[data-level="2"],
        .task-step[data-level="4"],
        .task-step[data-level="6"],
        .task-step[data-level="8"],
        .task-step[data-level="10"],
        .task-step[data-level="12"],
        .task-step[data-level="14"],
        .task-step[data-level="16"],
        .task-step[data-level="18"],
        .task-step[data-level="20"],
        .task-step[data-level="22"],
        .task-step[data-level="24"],
        .task-step[data-level="26"],
        .task-step[data-level="28"],
        .task-step[data-level="30"],
        .task-step[data-level="32"],
        .task-step[data-level="34"],
        .task-step[data-level="36"],
        .task-step[data-level="38"],
        .task-step[data-level="40"],
        .task-step[data-level="42"] {
            background: rgba(0, 255, 55, 0.171);
            border-left: 3px solid var(--green);
        }

        .task-step[data-level="1"],
        .task-step[data-level="3"],
        .task-step[data-level="5"],
        .task-step[data-level="7"],
        .task-step[data-level="9"],
        .task-step[data-level="11"],
        .task-step[data-level="13"],
        .task-step[data-level="15"],
        .task-step[data-level="17"],
        .task-step[data-level="19"],
        .task-step[data-level="21"],
        .task-step[data-level="23"],
        .task-step[data-level="25"],
        .task-step[data-level="27"],
        .task-step[data-level="29"],
        .task-step[data-level="31"],
        .task-step[data-level="33"],
        .task-step[data-level="35"],
        .task-step[data-level="37"],
        .task-step[data-level="39"],
        .task-step[data-level="41"],
        .task-step[data-level="43"] {
            background: rgba(46, 127, 167, 0.179);
            border-left: 3px solid var(--blue);
        }

        /* Indentation */
        .task-step[data-level="0"] {
            padding-left: 10px;
        }

        .task-step[data-level="1"] {
            padding-left: 30px;
        }

        .task-step[data-level="2"] {
            padding-left: 50px;
        }

        .task-step[data-level="3"] {
            padding-left: 70px;
        }

        .task-step[data-level="4"] {
            padding-left: 90px;
        }

        .task-step[data-level="5"] {
            padding-left: 110px;
        }

        /* Markers */
        .task-step[data-level="0"] .step-content::before,
        .task-step[data-level="2"] .step-content::before,
        .task-step[data-level="4"] .step-content::before,
        .task-step[data-level="6"] .step-content::before,
        .task-step[data-level="8"] .step-content::before,
        .task-step[data-level="10"] .step-content::before,
        .task-step[data-level="12"] .step-content::before,
        .task-step[data-level="14"] .step-content::before,
        .task-step[data-level="16"] .step-content::before,
        .task-step[data-level="18"] .step-content::before,
        .task-step[data-level="20"] .step-content::before,
        .task-step[data-level="22"] .step-content::before {
            content: '‚óÜ ';
            color: var(--green);
            font-size: 8px;
        }

        .task-step[data-level="1"] .step-content::before,
        .task-step[data-level="3"] .step-content::before,
        .task-step[data-level="5"] .step-content::before,
        .task-step[data-level="7"] .step-content::before,
        .task-step[data-level="9"] .step-content::before,
        .task-step[data-level="11"] .step-content::before,
        .task-step[data-level="13"] .step-content::before,
        .task-step[data-level="15"] .step-content::before,
        .task-step[data-level="17"] .step-content::before,
        .task-step[data-level="19"] .step-content::before,
        .task-step[data-level="21"] .step-content::before,
        .task-step[data-level="23"] .step-content::before {
            content: '‚óÜ ';
            color: var(--blue);
            font-size: 8px;
        }

        .task-step-checkbox {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--blue);
        }

        .collapse-icon {
            padding: 0px;
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            /* height: 17px; */
            /* border-radius: 6px; */
            font-size: 21px;
            font-weight: 700;
            color: var(--blue);
            margin-right: 6px;
            cursor: pointer;
            transition: all var(--t-fast);
            user-select: none;
        }

        .collapse-icon:hover {
            background: rgba(0, 122, 255, 0.12);
            transform: scale(1.1);
        }

        .step-content {
            max-width: 60vw;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: normal;
            word-break: break-word;
            max-width: 70vw;
            line-height: 1.4;
        }

        /* Expand-all controls */
        .expand-all-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            padding: 0 2px;
        }

        .expand-all-controls button {
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 100px;
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
        }

        .expand-all-controls button:hover {
            background: rgba(0, 0, 0, 0.09);
        }

        /* ‚îÄ‚îÄ Images in tasks ‚îÄ‚îÄ */
        .task-images-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 8px 16px;
            scrollbar-width: thin;
        }

        .task-images-scroll.single-image {
            justify-content: center;
        }

        .scroll-image {
            max-height: 130px;
            max-width: 180px;
            object-fit: cover;
            border-radius: var(--r-lg);
            flex-shrink: 0;
            cursor: pointer;
            transition: transform var(--t-fast);
            border: 1px solid var(--border);
        }

        .scroll-image:hover {
            transform: scale(1.02);
        }

        .task-images-scroll.single-image .scroll-image {
            max-width: 85%;
            max-height: 250px;
        }

        /* ‚îÄ‚îÄ Image modal ‚îÄ‚îÄ */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 100000;
            inset: 0;
            background: rgba(0, 0, 0, 0.88);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            align-items: center;
            justify-content: center;
        }

        .image-modal.open {
            display: flex;
        }

        .image-modal-content {
            display: block;
            margin: auto;
            max-width: 98vw;
            max-height: 85vh;
            border-radius: var(--r-xl);
            box-shadow: 0 32px 80px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 24px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 28px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            border: none;
            transition: background var(--t-fast);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 36px;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            user-select: none;
            line-height: 1;
            transition: background var(--t-fast);
        }

        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-arrow.left {
            left: 20px;
        }

        .nav-arrow.right {
            right: 20px;
        }

        /* ‚îÄ‚îÄ Edit / task modal ‚îÄ‚îÄ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--r-2xl);
            padding: 24px;
            max-width: 700px;
            width: 95%;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            animation: modalIn var(--t-med);
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.96) translateY(12px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        button.modal-close {
            background: rgb(250 230 230);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            border-radius: 50%;
            width: 39px;
            height: 39px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            cursor: pointer;
            box-shadow: none;
        }

        button.modal-close:hover {
            background: var(--red);
            color: #fff;
        }

        .preview-box {
            max-height: 200px;
            overflow-y: auto;
            border: 1.5px solid var(--border);
            padding: 12px;
            margin-bottom: 14px;
            background: var(--surface2);
            border-radius: var(--r-md);
            font-size: 13px;
        }

        #editTaskSteps {
            white-space: pre;
            overflow-x: auto;
            height: 140px;
            display: block;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }

        #resizeHandle {
            height: 24px;
            background: var(--surface2);
            border-radius: 0 0 var(--r-md) var(--r-md);
            cursor: ns-resize;
            text-align: center;
            font-size: 14px;
            line-height: 24px;
            color: var(--text-tertiary);
            touch-action: none;
        }

        #resizeHandle::before {
            content: "‚ãØ puxar para expandir";
        }

        .create-btn-row {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            align-items: center;
            justify-content: flex-end;
        }

        /* ‚îÄ‚îÄ Audio / Voice ‚îÄ‚îÄ */
        .audio-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--t-fast);
        }

        .audio-btn:hover {
            background: var(--blue-dark);
        }

        .audio-btn.recording {
            background: var(--red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.04);
            }
        }

        .audio-status {
            font-size: 13px;
            text-align: center;
            padding: 8px;
            border-radius: var(--r-md);
            margin-top: 8px;
            display: none;
        }

        .audio-status.listening {
            background: rgba(52, 199, 89, 0.12);
            color: #1a7a36;
            display: block;
        }

        .audio-status.error {
            background: rgba(255, 59, 48, 0.12);
            color: #b02020;
            display: block;
        }

        /* ‚îÄ‚îÄ Bottom floating bar ‚îÄ‚îÄ */
        .buttons-row {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 16px;
            border-radius: 100px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }

        #createTaskBtn {
            background: var(--green);
            color: #fff;
            border-radius: 100px;
            padding: 9px 18px;
            font-size: 15px;
            font-weight: 700;
        }

        #createTaskBtn:hover {
            filter: brightness(0.9);
        }

        #audioBtn {
            background: var(--blue);
            color: #fff;
            border-radius: 100px;
            padding: 9px 14px;
        }

        #voiceSearchBtn {
            background: var(--purple);
            color: #fff;
            border-radius: 100px;
            padding: 9px 14px;
            font-size: 15px;
        }

        #showMoreBtn {
            background: rgba(0, 122, 255, 0.1);
            color: var(--blue);
            border-radius: 100px;
            padding: 11px 14px;
            font-size: 13px;
            font-weight: 600;
        }

        #showMoreBtn:hover {
            background: var(--blue);
            color: #fff;
        }

        #exportBtn,
        #importBtn {
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-secondary);
            border-radius: 100px;
            padding: 9px 14px;
            font-size: 13px;
        }

        #exportBtn:hover,
        #importBtn:hover {
            background: rgba(0, 0, 0, 0.12);
            color: var(--text-primary);
        }

        .file-input {
            display: none;
        }

        /* ‚îÄ‚îÄ Status message ‚îÄ‚îÄ */
        #statusMessage {
            text-align: center;
            padding: 10px;
            border-radius: var(--r-md);
            background: rgba(52, 199, 89, 0.12);
            color: #1a7a36;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            margin-top: 8px;
            transition: opacity var(--t-fast);
        }

        #statusMessage.show {
            opacity: 1;
        }

        /* ‚îÄ‚îÄ Search highlight ‚îÄ‚îÄ */
        mark {
            background: rgba(255, 204, 0, 0.4);
            border-radius: 2px;
            padding: 0 1px;
        }

        /* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
        .hidden {
            display: none !important;
        }

        /* ‚îÄ‚îÄ Edit search inside modal ‚îÄ‚îÄ */
        #editModalSearchContainer {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        #editModalSearch {
            margin: 0;
        }

        #editModalVoiceSearch {
            background: var(--purple);
            color: #fff;
            border-radius: var(--r-md);
            padding: 7px 10px;
        }

        #editModalSearchClear {
            background: rgba(255, 59, 48, 0.1);
            color: var(--red);
            border-radius: var(--r-md);
            padding: 7px 10px;
        }

        #editModalSearchPrev,
        #editModalSearchNext {
            background: var(--blue);
            color: #fff;
            border-radius: var(--r-md);
            padding: 7px 10px;
        }

        #editModalSearchCounter {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ‚îÄ‚îÄ Botoesexpandir ‚îÄ‚îÄ */
        .botoesExpandir {
            display: flex;
            gap: 8px;
            justify-content: center;
            padding: 4px 16px 12px;
            flex-wrap: wrap;
            align-items: baseline;
        }

        .colorir {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            background: rgba(0, 122, 255, 0.08);
            color: var(--blue);
            border: none;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--t-fast);
        }

        .colorir:hover {
            background: rgba(0, 122, 255, 0.15);
        }

        /* ‚îÄ‚îÄ alinhe ‚îÄ‚îÄ */
        .alinhe {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ‚îÄ‚îÄ mostraEmodos ‚îÄ‚îÄ */
        .mostraEmodos {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        /* ‚îÄ‚îÄ view-mode-container ‚îÄ‚îÄ */
        .view-mode-container {
            position: relative;
        }

        .task-info {
            padding: 0px 5px 0px 10px;
        }

        #taskSteps {
            white-space: pre;
            overflow-x: auto;
        }

        .step-final {
            color: #dc3545 !important;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            body {
                padding: 0 12px 140px;
            }

            .buttons-row {
                bottom: 12px;
                padding: 5px 4px;
                gap: 5px;
                max-width: calc(105vw - 24px);
                flex-wrap: nowrap;
                justify-content: center;
                border-radius: 24px;
            }

            .task-name {
                font-style: italic;
                padding: 5px 10px 0px 20px;
                font-size: 16px;
            }

            .modal-content {
                padding: 16px;
                border-radius: var(--r-xl);
                max-height: 92vh;
                width: 98%;
            }

            .task-info {
                padding: 0px 5px 0px 18px;
            }

            #editTaskSteps {
                height: 100px;
                font-size: 14px;
            }

            .nav-arrow {
                display: none;
            }

            .step-content {
                max-width: 60vw;
            }

            .alinhe {
                justify-content: space-between;
                flex-direction: row;
            }

            .task-steps {
                min-height: 250px;
                max-height: 344px;
                overflow-y: auto;
                padding: 8px 16px 12px;
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
            }

            .create-btn-row {
                justify-content: space-between;
            }

            .camera-section {
                display: flex;
                gap: 7px;
                flex-wrap: wrap;
                align-items: center;
                margin-top: 6px;
                justify-content: center;
            }

            .ocultareinicia {
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>
    <!-- ‚îÄ‚îÄ Top creation form (hidden by default) ‚îÄ‚îÄ -->
    <div class="container">
        <div class="form-group">
            <label for="taskName">Nome do Cronograma</label>
            <input type="text" id="taskName" placeholder="Ex: Como fazer panquecas">
        </div>

        <div class="form-group">
            <label for="taskSteps">Passos (um por linha)</label>

            <textarea id="taskSteps"
                placeholder="M√©todos de indenta√ß√£o:&#10;&#10;Espa√ßos/Tab:&#10;Tarefa principal&#10;  Subtarefa&#10;    Sub-subtarefa&#10;&#10;"></textarea>
            <div class="indent-toolbar" id="indentToolbar" style="
                    display: flex;
                    gap: 6px;
                    flex-wrap: wrap;
                    margin-bottom: 8px;
                    align-items: center;
                    ">
                <button type="button" onclick="setLineLevel('taskSteps', 0)" title="N√≠vel raiz (sem indenta√ß√£o)" style="background:#4CAF50;color:white;border:none;border-radius:6px;
                padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                    ‚óÄ‚óÄ Raiz
                </button>
                <button type="button" onclick="decreaseLineLevel('taskSteps')" title="Subir um n√≠vel (desindentar)"
                    style="background:#2196F3;color:white;border:none;border-radius:6px;
                padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                    ‚óÄ Subir
                </button>
                <button type="button" onclick="increaseLineLevel('taskSteps')" title="Descer um n√≠vel (indentar)" style="background:#FF9800;color:white;border:none;border-radius:6px;
                padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                    Descer ‚ñ∂
                </button>
                <span id="taskSteps_levelIndicator" style="font-size:13px;color:#555;padding:4px 10px;
                background:#f0f0f0;border-radius:6px;min-width:70px;text-align:center;">
                    N√≠vel: 0
                </span>
            </div>
            <div class="indent-help">
                <strong>üí° Indenta√ß√£o:</strong> use espa√ßos, tabs, ou os bot√µes
            </div>
        </div>

        <div class="form-group">
            <label>Imagens (opcional)</label>
            <div class="alinhe">
                <button type="button" id="cameraBtn" class="camera-btn">üì∑ Tirar Foto</button>
                <button type="button" id="galleryBtn" class="gallery-btn">üñºÔ∏è da Galeria</button>
            </div>
            <div class="camera-section">
                <input type="file" id="taskImage" accept="image/*" multiple style="display:none;">
                <div id="imagePreview" class="image-preview"></div>
                <div class="images-count" id="imagesCount"></div>
            </div>
            <div class="ocultareinicia">
                <button id="toggleContainerBtn">Ocultar</button>
                <button id="resetGuideBtn">Reiniciar</button>
                <button id="adicionarmanual" onclick="createTask()">Criar</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Audio status ‚îÄ‚îÄ -->
    <div id="audioStatus" class="audio-status"></div>

    <!-- ‚îÄ‚îÄ Status toast ‚îÄ‚îÄ -->
    <div id="statusMessage" class="status-message"></div>

    <!-- ‚îÄ‚îÄ Toolbar row ‚îÄ‚îÄ -->
    <div class="toolbar">
        <div class="search-wrap">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <label for="searchInput"
                style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;">Pesquisar
                cronogramas</label>
            <input type="text" id="searchInput" name="searchInput" placeholder="Pesquisar cronogramas‚Ä¶"
                autocomplete="off">
            <button id="clearSearchBtn">‚úï</button>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Meta row: pagination + view mode ‚îÄ‚îÄ -->
    <div class="meta-row">
        <div class="pagination-controls" id="paginationControls">
            <button id="prevPageBtn">‚Äπ Anterior</button>
            <span id="pageInfo">P√°gina 1 de 1</span>
            <button id="nextPageBtn">Pr√≥ximo ‚Ä∫</button>
            <label for="pageSizeSelect"
                style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;">Itens
                por
                p√°gina</label>
            <select id="pageSizeSelect" name="pageSizeSelect">
                <option value="2">2 por p√°gina</option>
                <option value="5">5 por p√°gina</option>
                <option value="10" selected>10 por p√°gina</option>
                <option value="20">20 por p√°gina</option>
            </select>
        </div>
        <div class="mostraEmodos">
            <label for="viewModeSelect"
                style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;">Modo
                de
                visualiza√ß√£o</label>
            <select id="viewModeSelect" name="viewModeSelect">
                <option value="compact">Modo Compacto</option>
                <option value="all">Mostrar Todos</option>
            </select>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Task list ‚îÄ‚îÄ -->
    <div class="view-mode-container">
        <div class="task-list" id="taskList"></div>

        <!-- ‚îÄ‚îÄ Floating bottom bar ‚îÄ‚îÄ -->
        <div class="buttons-row">
            <button id="audioBtn" class="audio-btn">
                <span id="audioIcon">üé§</span>
                <span id="audioBtnText"></span>
            </button>
            <button id="voiceSearchBtn" title="Pesquisar por voz">üîç</button>
            <button id="createTaskBtn">‚ûï</button>
            <button id="showMoreBtn">Mais</button>
            <button id="exportBtn">Exportar</button>
            <button id="importBtn">Importar</button>
            <label for="importInput"
                style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;">Importar
                arquivo JSON</label>
            <input type="file" id="importInput" name="importInput" class="file-input" accept=".json">
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Edit modal ‚îÄ‚îÄ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="form-group">
                <label for="editTaskName">Nome do Cronograma</label>
                <input type="text" id="editTaskName">
            </div>

            <div id="editModalPreview" class="preview-box"></div>

            <div class="form-group">
                <label for="editTaskSteps">Passos (um por linha)</label>

                <textarea id="editTaskSteps"></textarea>
                <div class="indent-toolbar" id="editIndentToolbar" style="
                            margin-top: 10px;
                            display: flex;
                            gap: 6px;
                            flex-wrap: wrap;
                            margin-bottom: 8px;
                            align-items: center;
                            ">
                    <button type="button" onclick="setLineLevel('editTaskSteps', 0)" title="N√≠vel raiz (sem indenta√ß√£o)"
                        style="background:#4CAF50;color:white;border:none;border-radius:6px;
                            padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                        ‚óÄ‚óÄ Raiz
                    </button>
                    <button type="button" onclick="decreaseLineLevel('editTaskSteps')"
                        title="Subir um n√≠vel (desindentar)" style="background:#2196F3;color:white;border:none;border-radius:6px;
                            padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                        ‚óÄ Subir
                    </button>
                    <button type="button" onclick="increaseLineLevel('editTaskSteps')"
                        title="Descer um n√≠vel (indentar)" style="background:#FF9800;color:white;border:none;border-radius:6px;
                            padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;">
                        Descer ‚ñ∂
                    </button>
                    <span id="editTaskSteps_levelIndicator" style="font-size:13px;color:#555;padding:4px 10px;
                            background:#f0f0f0;border-radius:6px;min-width:70px;text-align:center;">
                        N√≠vel: 0
                    </span>
                </div>
                <div id="resizeHandle"></div>
            </div>

            <div class="form-group">
                <label>Imagens (opcional)</label>
                <div class="camera-section">
                    <div class="audio-btn-container">
                        <button id="editAudioBtn" class="audio-btn">
                            <span id="editAudioIcon">üé§</span>
                            <span id="editAudioBtnText"></span>
                        </button>
                    </div>
                    <button type="button" class="modal-close">‚úï</button>
                    <button type="button" id="editCameraBtn" class="camera-btn">üì∑ Tirar Foto</button>
                    <button type="button" id="editGalleryBtn" class="gallery-btn">üñºÔ∏è da Galeria</button>
                    <input type="file" id="editTaskImage" accept="image/*" multiple style="display:none;">
                </div>
                <div id="editImagePreview" class="image-preview"></div>
                <div id="editImagesCount" style="font-size:13px;color:var(--text-secondary);margin-top:6px;"></div>
                <div id="currentImagePreview" style="margin-top:10px;"></div>
            </div>

            <div id="editModalSearchContainer" class="task-local-search">
                <button id="editModalVoiceSearch" title="Pesquisar por voz">üéôÔ∏è</button>
                <button id="editModalSearchPrev" title="Anterior">‚óÄ</button>
                <button id="editModalSearchNext" title="Pr√≥xima">‚ñ∂</button>
                <button id="editModalSearchClear" title="Limpar">‚úñ</button>
                <input type="text" id="editModalSearch" class="cuqui0" placeholder="Pesquisar no texto‚Ä¶">
                <span id="editModalSearchCounter" class="search-counter"></span>
            </div>

            <div class="create-btn-row">
                <button id="saveTaskBtn" class="btn-primary">Salvar Altera√ß√µes</button>

            </div>
            <div id="editAudioStatus" class="audio-status"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Image zoom modal ‚îÄ‚îÄ -->
    <div id="imageModal" class="image-modal" style="display:none;">
        <button class="close-modal">&times;</button>
        <span class="nav-arrow left">&#10094;</span>
        <img id="modalImage" class="image-modal-content">
        <span class="nav-arrow right">&#10095;</span>
    </div>

    <script>
        // ==================== CONFIGURA√á√ïES DO BANCO DE DADOS ====================
        let db;
        const DB_NAME = 'CronogramasDB';
        const STORE_NAME = 'tasks';
        const DB_VERSION = 1;

        // ==================== ESTADO DA APLICA√á√ÉO ====================
        let tasks = [];
        let expandedTasks = new Set();
        let imagesMarkedForRemoval = [];
        let modalImages = [];
        let currentImageIndex = 0;
        let currentEditTaskId = null;

        // ==================== PAGINA√á√ÉO E VISUALIZA√á√ÉO ====================
        let currentPage = 1;
        let pageSize = 10;
        let filteredTasks = [];
        let viewMode = 'compact';
        let totalLoadedTasks = 2;

        // ==================== BUSCA LOCAL ====================
        let currentSearchMatches = [];
        let currentMatchIndex = 0;

        // ==================== RECONHECIMENTO DE VOZ (CRIAR) ====================
        let recognition = null;
        let isRecording = false;
        let isFirstAudioInput = true;

        // ==================== RECONHECIMENTO DE VOZ (EDITAR) ====================
        let isEditModalFirstAudioInput = true;
        let isEditModalRecording = false;

        // ==================== S√çNTESE DE VOZ (LEITURA) ====================
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let currentTaskId = null;
        let isPaused = false;
        let isReading = false;
        let currentReadingTaskId = null;

        // ==================== √ÅUDIO SEQUENCIAL ====================
        let currentAudioQueue = [];
        let currentAudioIndex = 0;
        let isPlayingSequence = false;
        let sequenceTimeout = null;
        const PAUSE_AFTER_TITLE = 1000;
        const PAUSE_BETWEEN_STEPS = 500;

        // ==================== C√ÇMERA ====================
        let capturedImagesData = [];
        let editCapturedImagesData = [];
        let currentStream = null;
        let currentFacingMode = 'environment';

        // ==================== CONEX√ÉO COM INDEXEDDB ====================
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (event) => {
            console.error('Erro ao abrir o banco de dados:', event.target.error);
            showStatusMessage('Erro ao abrir o banco de dados', 'error');
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('name', 'name', { unique: false });
                store.createIndex('createdAt', 'createdAt', { unique: false });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log('Banco de dados aberto com sucesso');
            loadTasks();
        };

        // ==================== FUN√á√ïES DE RECONHECIMENTO DE VOZ ====================
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAudioStatus('Reconhecimento de voz n√£o suportado neste navegador', 'error');
                const audioBtn = document.getElementById('audioBtn');
                if (audioBtn) audioBtn.style.display = 'none';
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = function () {
                console.log('Reconhecimento de voz iniciado');
                if (!isEditModalRecording) {
                    showAudioStatus('üé§ Escutando... Fale agora!', 'listening');
                }
            };

            recognition.onerror = function (event) {
                console.error('Erro no reconhecimento:', event.error);
                let errorMessage = 'Erro no reconhecimento de voz';

                switch (event.error) {
                    case 'no-speech':
                        errorMessage = 'Nenhuma fala detectada. Tente novamente.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microfone n√£o encontrado ou sem permiss√£o.';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Permiss√£o de microfone negada.';
                        break;
                }

                if (isEditModalRecording) {
                    showEditAudioStatus(errorMessage, 'error');
                } else {
                    showAudioStatus(errorMessage, 'error');
                }

                stopRecording();
                stopEditModalRecording();
            };

            recognition.onend = function () {
                console.log('Reconhecimento de voz finalizado');
                stopRecording();
                stopEditModalRecording();
                hideAudioStatus();
                hideEditAudioStatus();
            };

            return true;
        }

        function toggleAudioRecording() {
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('toggleContainerBtn');
            const resetBtn = document.getElementById('resetGuideBtn');

            if (resetBtn) {
                resetBtn.style.display = 'inline-block';
            }

            if (container.style.display === 'none') {
                container.style.display = 'block';

                if (toggleBtn) {
                    toggleBtn.style.display = 'inline-block';
                    toggleBtn.textContent = 'Ocultar Guia';
                }

                setTimeout(() => {
                    toggleAudioRecording();
                }, 300);

                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition && !initSpeechRecognition()) {
                return;
            }

            try {
                isRecording = true;
                const audioBtn = document.getElementById('audioBtn');
                const audioIcon = document.getElementById('audioIcon');
                const audioBtnText = document.getElementById('audioBtnText');

                audioBtn.classList.add('recording');
                audioIcon.textContent = '‚è∏Ô∏è';
                audioBtnText.textContent = 'Parar';

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript.trim();
                    console.log('Texto reconhecido na tela principal:', transcript);

                    if (transcript) {
                        handleAudioInput(transcript);
                    }
                };

                recognition.start();
            } catch (error) {
                console.error('Erro ao iniciar grava√ß√£o:', error);
                showAudioStatus('Erro ao iniciar grava√ß√£o', 'error');
                stopRecording();
            }
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }

            isRecording = false;
            const audioBtn = document.getElementById('audioBtn');
            const audioIcon = document.getElementById('audioIcon');
            const audioBtnText = document.getElementById('audioBtnText');

            if (audioBtn) audioBtn.classList.remove('recording');
            if (audioIcon) audioIcon.textContent = 'üé§';
            if (audioBtnText) audioBtnText.textContent = '';
        }

        function handleAudioInput(text) {
            const taskNameInput = document.getElementById('taskName');
            const taskStepsInput = document.getElementById('taskSteps');

            if (isFirstAudioInput) {
                taskNameInput.value = text;
                isFirstAudioInput = false;
                taskStepsInput.focus();

                showAudioStatus('‚úÖ T√≠tulo definido! Continue falando para adicionar passos...', 'listening');

                setTimeout(() => {
                    hideAudioStatus();
                }, 2000);
            } else {
                const currentSteps = taskStepsInput.value;
                const newStep = currentSteps ? currentSteps + '\n' + text : text;
                taskStepsInput.value = newStep;
                taskStepsInput.scrollTop = taskStepsInput.scrollHeight;

                showAudioStatus('‚úÖ Passo adicionado!', 'listening');

                setTimeout(() => {
                    hideAudioStatus();
                }, 1500);
            }
        }

        function showAudioStatus(message, type) {
            const audioStatus = document.getElementById('audioStatus');
            if (audioStatus) {
                audioStatus.textContent = message;
                audioStatus.className = `audio-status ${type}`;
            }
        }

        function hideAudioStatus() {
            const audioStatus = document.getElementById('audioStatus');
            if (audioStatus) {
                audioStatus.className = 'audio-status';
            }
        }

        // ==================== FUN√á√ïES DE RECONHECIMENTO DE VOZ (MODAL EDITAR) ====================
        function toggleEditModalAudioRecording() {
            if (!recognition && !initSpeechRecognition()) {
                return;
            }

            if (isEditModalRecording) {
                stopEditModalRecording();
            } else {
                startEditModalRecording();
            }
        }

        function startEditModalRecording() {
            try {
                isEditModalRecording = true;
                const editAudioBtn = document.getElementById('editAudioBtn');
                const editAudioIcon = document.getElementById('editAudioIcon');
                const editAudioBtnText = document.getElementById('editAudioBtnText');

                editAudioBtn.classList.add('recording');
                editAudioIcon.textContent = '‚è∏Ô∏è';
                editAudioBtnText.textContent = 'Parar';

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript.trim();
                    console.log('Texto reconhecido no modal:', transcript);

                    if (transcript) {
                        handleEditModalAudioInput(transcript);
                    }
                };

                recognition.start();
                showEditAudioStatus('üé§ Escutando... Fale agora!', 'listening');
            } catch (error) {
                console.error('Erro ao iniciar grava√ß√£o no modal:', error);
                showEditAudioStatus('Erro ao iniciar grava√ß√£o', 'error');
                stopEditModalRecording();
            }
        }

        function stopEditModalRecording() {
            if (recognition && isEditModalRecording) {
                recognition.stop();
            }

            isEditModalRecording = false;
            const editAudioBtn = document.getElementById('editAudioBtn');
            const editAudioIcon = document.getElementById('editAudioIcon');
            const editAudioBtnText = document.getElementById('editAudioBtnText');

            if (editAudioBtn) editAudioBtn.classList.remove('recording');
            if (editAudioIcon) editAudioIcon.textContent = 'üé§';
            if (editAudioBtnText) editAudioBtnText.textContent = '';
        }

        function handleEditModalAudioInput(text) {
            const editTaskNameInput = document.getElementById('editTaskName');
            const editTaskStepsInput = document.getElementById('editTaskSteps');

            if (isEditModalFirstAudioInput) {
                editTaskNameInput.value = text;
                isEditModalFirstAudioInput = false;
                editTaskStepsInput.focus();

                showEditAudioStatus('‚úÖ T√≠tulo definido! Continue falando para adicionar passos...', 'listening');

                setTimeout(() => {
                    hideEditAudioStatus();
                }, 2000);
            } else {
                const currentSteps = editTaskStepsInput.value;
                const newStep = currentSteps ? currentSteps + '\n' + text : text;
                editTaskStepsInput.value = newStep;
                editTaskStepsInput.scrollTop = editTaskStepsInput.scrollHeight;

                showEditAudioStatus('‚úÖ Passo adicionado!', 'listening');

                setTimeout(() => {
                    hideEditAudioStatus();
                }, 1500);
            }
        }

        function showEditAudioStatus(message, type) {
            const editAudioStatus = document.getElementById('editAudioStatus');
            if (editAudioStatus) {
                editAudioStatus.textContent = message;
                editAudioStatus.className = `audio-status ${type}`;
            }
        }

        function hideEditAudioStatus() {
            const editAudioStatus = document.getElementById('editAudioStatus');
            if (editAudioStatus) {
                editAudioStatus.className = 'audio-status';
            }
        }

        // ==================== FUN√á√ïES DE S√çNTESE DE VOZ ====================
        function checkSpeechSynthesisSupport() {
            if (!('speechSynthesis' in window)) {
                console.warn('S√≠ntese de voz n√£o suportada neste navegador');
                return false;
            }
            return true;
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                ('ontouchstart' in window) ||
                (navigator.maxTouchPoints > 0);
        }

        function toggleReadTask(taskId) {
            if (!checkSpeechSynthesisSupport()) return;

            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const isMobile = isMobileDevice();

            if (isMobile) {
                if (isPlayingSequence && currentTaskId === taskId) {
                    stopAudioSequence();
                    return;
                }

                if (isPlayingSequence) {
                    stopAudioSequence();
                }

                currentTaskId = taskId;
                currentAudioQueue = createAudioQueue(task);
                currentAudioIndex = 0;
                isPlayingSequence = true;

                updateReadButton(taskId, true, false);
                playNextInQueue();
                return;
            }

            if (isPlayingSequence && currentTaskId === taskId) {
                if (!isPaused) {
                    speechSynthesis.pause();
                    if (sequenceTimeout) {
                        clearTimeout(sequenceTimeout);
                        sequenceTimeout = null;
                    }
                    isPaused = true;
                    updateReadButton(taskId, true, true);
                } else {
                    const currentItem = currentAudioQueue[currentAudioIndex];
                    if (currentItem && currentItem.type === 'pause') {
                        currentAudioIndex++;
                        playNextInQueue();
                    } else {
                        speechSynthesis.resume();
                    }
                    isPaused = false;
                    updateReadButton(taskId, true, false);
                }
            } else {
                if (isPlayingSequence) {
                    stopAudioSequence();
                }

                currentTaskId = taskId;
                currentAudioQueue = createAudioQueue(task);
                currentAudioIndex = 0;
                isPlayingSequence = true;
                isPaused = false;

                updateReadButton(taskId, true, false);
                playNextInQueue();
            }
        }

        function updateReadButton(taskId, isCurrentlyReading, isPausedState = false) {
            const readBtn = document.querySelector(`[data-taskid="${taskId}"].read-task-btn`);
            if (readBtn) {
                const btnText = readBtn.querySelector('.read-btn-text');
                const isMobile = isMobileDevice();

                if (isCurrentlyReading) {
                    readBtn.classList.add('reading');
                    if (isMobile) {
                        btnText.textContent = '‚èπÔ∏è Parar';
                    } else {
                        btnText.textContent = isPausedState ? '‚ñ∂Ô∏è Continuar' : '‚è∏Ô∏è Pausar';
                    }
                } else {
                    readBtn.classList.remove('reading');
                    btnText.textContent = 'üîä Ler';
                }
            }
        }

        function createAudioQueue(task) {
            const queue = [];
            queue.push({ type: 'speech', text: task.name });
            queue.push({ type: 'pause', duration: PAUSE_AFTER_TITLE });

            task.steps.forEach((step, index) => {
                queue.push({ type: 'speech', text: step.text });
                if (index < task.steps.length - 1) {
                    queue.push({ type: 'pause', duration: PAUSE_BETWEEN_STEPS });
                }
            });

            return queue;
        }

        function playNextInQueue() {
            if (currentAudioIndex >= currentAudioQueue.length) {
                stopAudioSequence();
                return;
            }

            const currentItem = currentAudioQueue[currentAudioIndex];

            if (currentItem.type === 'pause') {
                sequenceTimeout = setTimeout(() => {
                    currentAudioIndex++;
                    playNextInQueue();
                }, currentItem.duration);
            } else {
                currentUtterance = new SpeechSynthesisUtterance(currentItem.text);
                currentUtterance.rate = 0.9;
                currentUtterance.pitch = 1;
                currentUtterance.volume = 1;

                currentUtterance.onend = () => {
                    currentAudioIndex++;
                    playNextInQueue();
                };

                currentUtterance.onerror = () => {
                    stopAudioSequence();
                };

                speechSynthesis.speak(currentUtterance);
            }
        }

        function stopAudioSequence() {
            speechSynthesis.cancel();
            if (sequenceTimeout) {
                clearTimeout(sequenceTimeout);
                sequenceTimeout = null;
            }
            isPlayingSequence = false;
            currentAudioQueue = [];
            currentAudioIndex = 0;

            if (currentTaskId) {
                updateReadButton(currentTaskId, false);
            }

            currentTaskId = null;
            currentUtterance = null;
            isPaused = false;
        }

        function readAndCheckNextStep(taskId) {
            if (!checkSpeechSynthesisSupport()) return;

            const taskElement = document
                .querySelector(`[data-taskid="${taskId}"]`)
                ?.closest('.task-item');

            if (!taskElement) return;

            const taskTitle = taskElement.querySelector('.task-name')?.textContent || '';
            const checkboxes = taskElement.querySelectorAll('.task-step-checkbox');

            const uncheckedSteps = Array.from(checkboxes).filter(cb => !cb.checked);

            if (uncheckedSteps.length === 0) {
                alert('Todos os passos j√° foram conclu√≠dos!');
                return;
            }

            const currentStepCheckbox = uncheckedSteps[0];
            const currentStepElement = currentStepCheckbox.closest('.task-step');

            const stepText = currentStepElement
                .querySelector('.step-content')?.textContent || '';

            const isFirstStep = uncheckedSteps.length === checkboxes.length;
            const fullText = isFirstStep ? `${taskTitle}. ${stepText}` : stepText;

            focusPendingStep(taskElement);

            const utterance = new SpeechSynthesisUtterance(fullText);

            utterance.onend = () => {
                currentStepCheckbox.checked = true;
                currentStepCheckbox.dispatchEvent(new Event('change'));

                setTimeout(() => {
                    focusPendingStep(taskElement);
                }, 100);
            };

            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        function focusPendingStep(taskElement) {
            const stepsContainer = taskElement.querySelector('.task-steps');
            if (!stepsContainer) return;

            const steps = stepsContainer.querySelectorAll('.task-step');

            const stepToFocus = Array.from(steps).find(step => {
                const checkbox = step.querySelector('.task-step-checkbox');
                return checkbox && !checkbox.checked;
            });

            if (!stepToFocus) return;

            steps.forEach(s => s.classList.remove('active'));
            stepToFocus.classList.add('active');

            stepToFocus.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
        // ==================== FUN√á√ïES DE LISTAS ANINHADAS ====================

        // ==================== SISTEMA H√çBRIDO DE INDENTA√á√ÉO ====================
        // ==================== SISTEMA DE N√çVEIS POR N√öMERO ====================
        function detectIndentationLevel(line) {
            if (!line.trim()) return { level: 0, text: '', originalIndent: '', type: 'spaces' };

            // SISTEMA PRINCIPAL: contar espa√ßos no in√≠cio (2 espa√ßos = 1 n√≠vel)
            const spaceMatch = line.match(/^( *)(.*)/);
            const indent = spaceMatch[1] || '';
            const text = spaceMatch[2].trim();
            const level = Math.floor(indent.length / 2);

            return {
                level,
                text,
                originalIndent: '  '.repeat(level),
                type: 'spaces',
                marker: null
            };
        }

        // SUBSTITUA a fun√ß√£o completa:
        function parseStepsWithLevels(stepsText) {
            const lines = stepsText.split('\n');
            const parsedSteps = [];

            lines.forEach(line => {
                if (line.trim().length === 0) return;

                const { level, text, originalIndent, type, marker } = detectIndentationLevel(line);
                parsedSteps.push({
                    text,
                    level,
                    originalIndent,
                    type,
                    marker,
                    completed: false
                });
            });

            return parsedSteps;
        }

        // SUBSTITUA a fun√ß√£o completa:
        function reconstructStepsText(steps) {
            return steps.map(step => {
                const level = step.level || 0;
                return '  '.repeat(level) + step.text;
            }).join('\n');
        }

        // ==================== FUN√á√ïES DE CRUD ====================
        function createTask() {
            const taskNameInput = document.getElementById('taskName');
            const taskStepsInput = document.getElementById('taskSteps');
            const taskImageInput = document.getElementById('taskImage');

            const name = taskNameInput.value.trim();
            if (!name) {
                showStatusMessage('Por favor, insira um nome para o cronograma', 'error');
                return;
            }

            const stepsText = taskStepsInput.value.trim();
            if (!stepsText) {
                showStatusMessage('Por favor, insira pelo menos um passo', 'error');
                return;
            }

            // MUDAN√áA AQUI: usar parseStepsWithLevels
            const steps = parseStepsWithLevels(stepsText);

            let imagesData = [];

            if (capturedImagesData.length > 0) {
                imagesData = [...capturedImagesData];
            }

            if (taskImageInput.files && taskImageInput.files.length > 0) {
                const filePromises = Array.from(taskImageInput.files).map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(filePromises).then(galleryImages => {
                    imagesData = [...imagesData, ...galleryImages];

                    const task = {
                        name,
                        steps,
                        images: imagesData,
                        createdAt: new Date().toISOString(),
                        completed: false
                    };

                    saveTask(task);
                    clearCreateForm();
                    // ===== ADICIONE ESTAS LINHAS =====
                    // Ocultar o formul√°rio
                    const container = document.querySelector('.container');
                    const toggleBtn = document.getElementById('toggleContainerBtn');
                    if (container) container.style.display = 'none';
                    if (toggleBtn) toggleBtn.style.display = 'none';

                    // Mostrar todas as tarefas novamente
                    setTimeout(() => {
                        const allTaskItems = document.querySelectorAll('.task-item');
                        allTaskItems.forEach(item => {
                            item.style.display = 'block';
                        });
                    }, 100);
                    // ===== FIM =====

                });
                return;
            }

            const task = {
                name,
                steps,
                images: imagesData,
                createdAt: new Date().toISOString(),
                completed: false
            };

            saveTask(task);
            clearCreateForm();
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('toggleContainerBtn');
            if (container) container.style.display = 'none';
            if (toggleBtn) toggleBtn.style.display = 'none';

            // Mostrar todas as tarefas novamente
            setTimeout(() => {
                const allTaskItems = document.querySelectorAll('.task-item');
                allTaskItems.forEach(item => {
                    item.style.display = 'block';
                });
            }, 100);
        }

        function clearCreateForm() {
            const taskNameInput = document.getElementById('taskName');
            const taskStepsInput = document.getElementById('taskSteps');
            const taskImageInput = document.getElementById('taskImage');

            taskNameInput.value = '';
            taskStepsInput.value = '';
            taskImageInput.value = '';
            capturedImagesData = [];
            document.getElementById('imagePreview').innerHTML = '';
            updateImagesCount('imagesCount', 0);
            isFirstAudioInput = true;
        }

        function saveTask(task) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);

            const request = store.add(task);

            request.onsuccess = () => {
                showStatusMessage('Cronograma criado com sucesso!');
                if (viewMode === 'compact') {
                    totalLoadedTasks = 2;
                }
                loadTasks();
            };

            request.onerror = (event) => {
                console.error('Erro ao salvar o cronograma:', event.target.error);
                showStatusMessage('Erro ao salvar o cronograma', 'error');
            };
        }

        function openEditModal(taskId) {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(taskId);

            request.onsuccess = (event) => {
                const task = event.target.result;

                if (task) {
                    const editTaskNameInput = document.getElementById('editTaskName');
                    const editTaskStepsInput = document.getElementById('editTaskSteps');
                    const currentImagePreview = document.getElementById('currentImagePreview');
                    const taskModal = document.getElementById('taskModal');

                    editTaskNameInput.value = task.name;
                    editTaskStepsInput.value = reconstructStepsText(task.steps);
                    // üî• Colocar foco e criar nova linha automaticamente
                    setTimeout(() => {
                        editTaskStepsInput.focus();

                        // Se j√° tiver conte√∫do e n√£o terminar com quebra de linha
                        if (
                            editTaskStepsInput.value &&
                            !editTaskStepsInput.value.endsWith('\n')
                        ) {
                            editTaskStepsInput.value += '\n';
                        }

                        // Move cursor para o final
                        const end = editTaskStepsInput.value.length;
                        editTaskStepsInput.setSelectionRange(end, end);

                        // üî• Scroll vertical para baixo
                        editTaskStepsInput.scrollTop = editTaskStepsInput.scrollHeight;

                        // üî• Resetar scroll horizontal
                        editTaskStepsInput.scrollLeft = 0;

                    }, 50);


                    // Adicionar busca no modal se n√£o existir

                    currentEditTaskId = taskId;

                    if (task.images && task.images.length > 0) {
                        let imagesHtml = `
                                <div style="text-align: center;">
                                    <p>Imagens atuais:</p>
                                    <div style="display: flex; overflow-x: auto; gap: 10px; padding: 10px 0;">
                            `;

                        task.images.forEach((image, index) => {
                            imagesHtml += `
                                    <div style="position: relative; display: inline-block;">
                                        <img src="${image}" 
                                            alt="Imagem ${index + 1}" 
                                            class="edit-scroll-image" 
                                            style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                                        <button type="button" onclick="removeExistingImage(${index})"
                                                style="position: absolute; top: -2px; right: -2px; background: #f0000000; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; padding: 0; justify-content: center; align-items: center;">‚ùå</button>
                                    </div>
                                `;
                        });

                        imagesHtml += `
                                    </div>
                                    <small>Adicione novas imagens ou remova as existentes</small>

                                </div>
                            `;

                        currentImagePreview.innerHTML = imagesHtml;

                        setTimeout(() => {
                            const editImages = currentImagePreview.querySelectorAll('.edit-scroll-image');
                            const imageModal = document.getElementById('imageModal');
                            const modalImage = document.getElementById('modalImage');

                            editImages.forEach(img => {
                                img.addEventListener('click', () => {
                                    modalImage.src = img.src;
                                    imageModal.style.display = 'block';
                                });
                            });
                        }, 0);
                    } else if (task.image) {
                        currentImagePreview.innerHTML = `
                                        <div style="text-align: center;">
                                            <p>Imagem atual:</p>
                                            <img src="${task.image}" 
                                                alt="Imagem atual" 
                                                class="edit-scroll-image" 
                                                style="max-width: 200px; max-height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                                            <br><small>Adicione novas imagens para substituir</small>
                                        </div>
                                    `;

                        setTimeout(() => {
                            const img = currentImagePreview.querySelector('.edit-scroll-image');
                            const imageModal = document.getElementById('imageModal');
                            const modalImage = document.getElementById('modalImage');

                            if (img) {
                                img.addEventListener('click', () => {
                                    modalImage.src = img.src;
                                    imageModal.style.display = 'block';
                                });
                            }
                        }, 0);
                    } else {
                        currentImagePreview.innerHTML = '<p>Nenhuma imagem definida</p>';
                    }

                    editCapturedImagesData = [];
                    document.getElementById('editImagePreview').innerHTML = '';
                    updateImagesCount('editImagesCount', 0);

                    isEditModalFirstAudioInput = true;
                    isEditModalRecording = false;

                    const editAudioBtn = document.getElementById('editAudioBtn');
                    const editAudioIcon = document.getElementById('editAudioIcon');
                    const editAudioBtnText = document.getElementById('editAudioBtnText');

                    if (editAudioBtn) editAudioBtn.classList.remove('recording');
                    if (editAudioIcon) editAudioIcon.textContent = 'üé§';
                    if (editAudioBtnText) editAudioBtnText.textContent = '';
                    hideEditAudioStatus();
                    // Configurar busca do modal
                    setTimeout(() => {
                        const editModalSearch = document.getElementById('editModalSearch');
                        const editModalSearchPrev = document.getElementById('editModalSearchPrev');
                        const editModalSearchNext = document.getElementById('editModalSearchNext');
                        const editModalSearchClear = document.getElementById('editModalSearchClear');
                        const editTaskSteps = document.getElementById('editTaskSteps');

                        if (editModalSearch) {
                            const newInput = editModalSearch.cloneNode(true);
                            editModalSearch.parentNode.replaceChild(newInput, editModalSearch);
                            newInput.addEventListener('input', (e) => {
                                searchInTextarea(editTaskSteps, e.target.value, (text) => {
                                    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                                });
                            });
                        }

                        if (editModalSearchPrev) {
                            const newBtn = editModalSearchPrev.cloneNode(true);
                            editModalSearchPrev.parentNode.replaceChild(newBtn, editModalSearchPrev);
                            newBtn.addEventListener('click', prevTextareaMatch);
                        }

                        if (editModalSearchNext) {
                            const newBtn = editModalSearchNext.cloneNode(true);
                            editModalSearchNext.parentNode.replaceChild(newBtn, editModalSearchNext);
                            newBtn.addEventListener('click', nextTextareaMatch);
                        }

                        if (editModalSearchClear) {
                            const newBtn = editModalSearchClear.cloneNode(true);
                            editModalSearchClear.parentNode.replaceChild(newBtn, editModalSearchClear);
                            newBtn.addEventListener('click', () => clearTextareaSearch(editTaskSteps));
                        }
                        // üî• EVENT LISTENER PARA BUSCA POR VOZ
                        const editModalVoiceSearch = document.getElementById('editModalVoiceSearch');
                        if (editModalVoiceSearch && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                            const modalRecognition = new SpeechRecognition();

                            modalRecognition.lang = 'pt-BR';
                            modalRecognition.interimResults = false;

                            const newVoiceBtn = editModalVoiceSearch.cloneNode(true);
                            editModalVoiceSearch.parentNode.replaceChild(newVoiceBtn, editModalVoiceSearch);

                            newVoiceBtn.addEventListener('click', () => {
                                modalRecognition.start();
                            });

                            modalRecognition.onresult = (event) => {
                                const transcript = event.results[0][0].transcript;
                                const searchInput = document.getElementById('editModalSearch');
                                if (searchInput) {
                                    searchInput.value = transcript;
                                    searchInput.dispatchEvent(new Event('input'));
                                }
                            };

                            modalRecognition.onerror = (event) => {
                                console.error('Erro no reconhecimento de voz do modal:', event.error);
                            };
                        } else if (editModalVoiceSearch) {
                            // Se n√£o suportar, desabilitar o bot√£o
                            editModalVoiceSearch.disabled = true;
                            editModalVoiceSearch.title = 'Reconhecimento de voz n√£o suportado';
                            editModalVoiceSearch.style.opacity = '0.5';
                        }
                    }, 100);

                    // Desabilitar quebra de linha
                    editTaskStepsInput.setAttribute('wrap', 'off');
                    editTaskStepsInput.style.whiteSpace = 'pre';
                    editTaskStepsInput.style.overflowX = 'auto';
                    taskModal.style.display = 'flex';
                }
            };

            request.onerror = (event) => {
                console.error('Erro ao obter o cronograma para edi√ß√£o:', event.target.error);
                showStatusMessage('Erro ao obter o cronograma para edi√ß√£o', 'error');
            };
        }

        function closeModal() {
            if (isEditModalRecording) {
                stopEditModalRecording();
            }
            // Limpar busca do modal
            const editTaskSteps = document.getElementById('editTaskSteps');
            if (editTaskSteps) {
                clearTextareaSearch(editTaskSteps);
            }

            const taskModal = document.getElementById('taskModal');
            const editTaskImageInput = document.getElementById('editTaskImage');
            const currentImagePreview = document.getElementById('currentImagePreview');

            taskModal.style.display = 'none';
            currentEditTaskId = null;
            editTaskImageInput.value = '';
            currentImagePreview.innerHTML = '';
            isEditModalFirstAudioInput = true;
            isEditModalRecording = false;
            window.removeImageFlag = false;
            editCapturedImageData = null;
            const editImagePreview = document.getElementById('editImagePreview');
            if (editImagePreview) editImagePreview.innerHTML = '';
        }

        function saveTaskChanges() {
            if (!currentEditTaskId) return;

            const editTaskNameInput = document.getElementById('editTaskName');
            const editTaskStepsInput = document.getElementById('editTaskSteps');
            const editTaskImageInput = document.getElementById('editTaskImage');

            const name = editTaskNameInput.value.trim();
            if (!name) {
                showStatusMessage('Por favor, insira um nome para o cronograma', 'error');
                return;
            }

            const stepsText = editTaskStepsInput.value.trim();
            if (!stepsText) {
                showStatusMessage('Por favor, insira pelo menos um passo', 'error');
                return;
            }

            const steps = parseStepsWithLevels(stepsText);

            let allImages = [];

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const getRequest = store.get(currentEditTaskId);

            getRequest.onsuccess = (event) => {
                const currentTask = event.target.result;
                if (currentTask && currentTask.images) {
                    allImages = [...currentTask.images];
                } else if (currentTask && currentTask.image) {
                    allImages = [currentTask.image];
                }

                if (editCapturedImagesData.length > 0) {
                    allImages = [...allImages, ...editCapturedImagesData];
                }

                if (editTaskImageInput.files && editTaskImageInput.files.length > 0) {
                    const filePromises = Array.from(editTaskImageInput.files).map(file => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                resolve(e.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                    });

                    Promise.all(filePromises).then(galleryImages => {
                        allImages = [...allImages, ...galleryImages];

                        if (imagesMarkedForRemoval.length > 0) {
                            allImages = allImages.filter((_, index) => !imagesMarkedForRemoval.includes(index));
                        }

                        updateTaskInDatabase(name, steps, allImages);
                        imagesMarkedForRemoval = [];
                    });
                } else {
                    if (imagesMarkedForRemoval.length > 0) {
                        allImages = allImages.filter((_, index) => !imagesMarkedForRemoval.includes(index));
                    }

                    updateTaskInDatabase(name, steps, allImages);
                    imagesMarkedForRemoval = [];
                }
            };
        }

        function updateTaskInDatabase(name, steps, imagesData) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(currentEditTaskId);

            request.onsuccess = (event) => {
                const task = event.target.result;

                if (task) {
                    const updatedSteps = steps.map((newStep, index) => {
                        if (task.steps[index]) {
                            return {
                                text: newStep.text,
                                level: newStep.level,
                                originalIndent: newStep.originalIndent,
                                completed: task.steps[index].completed
                            };
                        }
                        return {
                            text: newStep.text,
                            level: newStep.level,
                            originalIndent: newStep.originalIndent,
                            completed: false
                        };
                    });

                    task.name = name;
                    task.steps = updatedSteps;

                    if (imagesData === 'REMOVE_IMAGES') {
                        task.images = [];
                    } else if (Array.isArray(imagesData)) {
                        task.images = imagesData;
                    }

                    task.completed = task.steps.every(step => step.completed);

                    const updateRequest = store.put(task);

                    updateRequest.onsuccess = () => {
                        showStatusMessage('Cronograma atualizado com sucesso!', 'success');
                        closeModal();
                        loadTasks();

                        const editTaskImageInput = document.getElementById('editTaskImage');
                        if (editTaskImageInput) editTaskImageInput.value = '';
                        editCapturedImagesData = [];
                        const preview = document.getElementById('editImagePreview');
                        if (preview) preview.innerHTML = '';
                        updateImagesCount('editImagesCount', 0);
                        isEditModalFirstAudioInput = true;
                    };

                    updateRequest.onerror = (event) => {
                        console.error('Erro ao atualizar cronograma:', event.target.error);
                        showStatusMessage('Erro ao atualizar cronograma', 'error');
                    };
                }
            };

            request.onerror = (event) => {
                console.error('Erro ao obter cronograma para edi√ß√£o:', event.target.error);
                showStatusMessage('Erro ao obter cronograma para edi√ß√£o', 'error');
            };
        }

        function deleteTask(taskId) {
            if (confirm('Tem certeza que deseja excluir este cronograma?')) {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(taskId);

                request.onsuccess = () => {
                    loadTasks();
                    showStatusMessage('Cronograma exclu√≠do com sucesso!');
                };

                request.onerror = (event) => {
                    console.error('Erro ao excluir o cronograma:', event.target.error);
                    showStatusMessage('Erro ao excluir o cronograma', 'error');
                };
            }
        }

        function removeExistingImage(index) {
            if (!imagesMarkedForRemoval.includes(index)) {
                imagesMarkedForRemoval.push(index);
            }

            const currentImagePreview = document.getElementById('currentImagePreview');
            const imageContainers = currentImagePreview.querySelectorAll('.edit-scroll-image');
            if (imageContainers[index]) {
                imageContainers[index].style.opacity = '0.3';
                imageContainers[index].style.pointerEvents = 'none';
                const button = imageContainers[index].parentElement.querySelector('button');
                if (button) {
                    button.textContent = '‚Ü©Ô∏è';
                    button.onclick = () => undoRemoveImage(index);
                }
            }
        }

        function undoRemoveImage(index) {
            imagesMarkedForRemoval = imagesMarkedForRemoval.filter(i => i !== index);
            const currentImagePreview = document.getElementById('currentImagePreview');
            const imageContainers = currentImagePreview.querySelectorAll('.edit-scroll-image');
            if (imageContainers[index]) {
                imageContainers[index].style.opacity = '1';
                imageContainers[index].style.pointerEvents = 'auto';
                const button = imageContainers[index].parentElement.querySelector('button');
                if (button) {
                    button.textContent = '‚ùå';
                    button.onclick = () => removeExistingImage(index);
                }
            }
        }

        function resetTaskSteps(taskId) {
            const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
            if (!taskElement) return;

            const checkboxes = taskElement.querySelectorAll('.task-step-checkbox');

            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.dispatchEvent(new Event('change'));
            });
        }

        // ==================== FUN√á√ïES DE IMPORTA√á√ÉO E EXPORTA√á√ÉO ====================
        function exportTasks() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = (event) => {
                const tasks = event.target.result;

                if (tasks.length === 0) {
                    showStatusMessage('N√£o h√° cronogramas para exportar', 'error');
                    return;
                }

                const dataStr = JSON.stringify(tasks, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const exportLink = document.createElement('a');
                exportLink.setAttribute('href', dataUri);
                exportLink.setAttribute('download', `cronogramas_${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(exportLink);

                exportLink.click();
                document.body.removeChild(exportLink);

                showStatusMessage('Cronogramas exportados com sucesso!');
            };

            request.onerror = (event) => {
                console.error('Erro ao exportar cronogramas:', event.target.error);
                showStatusMessage('Erro ao exportar cronogramas', 'error');
            };
        }

        function importTasks(event) {
            const file = event.target.files[0];

            if (!file) return;

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const tasks = JSON.parse(e.target.result);

                    if (!Array.isArray(tasks)) throw new Error('Formato inv√°lido');

                    if (confirm('Deseja substituir todos os cronogramas existentes?\n\n‚Ä¢ OK = Substituir tudo\n‚Ä¢ Cancelar = Mesclar com os existentes')) {
                        const clearTransaction = db.transaction([STORE_NAME], 'readwrite');
                        const clearStore = clearTransaction.objectStore(STORE_NAME);
                        const clearRequest = clearStore.clear();

                        clearRequest.onsuccess = () => {
                            addImportedTasks(tasks, 'substitu√≠dos');
                        };

                        clearRequest.onerror = (error) => {
                            console.error('Erro ao limpar cronogramas existentes:', error);
                            showStatusMessage('Erro ao substituir cronogramas', 'error');
                            event.target.value = '';
                        };
                    } else {
                        const transaction = db.transaction([STORE_NAME], 'readonly');
                        const store = transaction.objectStore(STORE_NAME);
                        const getAllRequest = store.getAll();

                        getAllRequest.onsuccess = () => {
                            const existingTasks = getAllRequest.result;
                            const existingNames = new Set(existingTasks.map(t => t.name.trim().toLowerCase()));

                            const uniqueTasks = tasks.filter(t => !existingNames.has(t.name.trim().toLowerCase()));

                            addImportedTasks(uniqueTasks, 'mesclados');
                        };

                        getAllRequest.onerror = (event) => {
                            console.error('Erro ao buscar tarefas existentes para mesclar:', event.target.error);
                            showStatusMessage('Erro ao verificar duplicatas', 'error');
                            event.target.value = '';
                        };
                    }

                } catch (error) {
                    console.error('Erro ao processar o arquivo JSON:', error);
                    showStatusMessage('Erro ao processar o arquivo. Certifique-se de que √© um arquivo JSON v√°lido', 'error');
                    event.target.value = '';
                }
            };

            reader.onerror = () => {
                console.error('Erro ao ler o arquivo');
                showStatusMessage('Erro ao ler o arquivo', 'error');
                event.target.value = '';
            };

            reader.readAsText(file);

            function addImportedTasks(tasks, operation) {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                let importedCount = 0;
                let promises = [];

                tasks.forEach(task => {
                    const cleanTask = { ...task };
                    delete cleanTask.id;

                    const promise = new Promise((resolve) => {
                        const addRequest = store.add(cleanTask);

                        addRequest.onsuccess = () => {
                            importedCount++;
                            resolve();
                        };

                        addRequest.onerror = () => {
                            resolve();
                        };
                    });

                    promises.push(promise);
                });

                Promise.all(promises).then(() => {
                    loadTasks();
                    showStatusMessage(`${importedCount} cronograma(s) ${operation} com sucesso!`);
                    event.target.value = '';
                });
            }
        }

        // ==================== FUN√á√ïES DE RENDERIZA√á√ÉO ====================
        function loadTasks() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = (event) => {
                tasks = event.target.result;

                const searchInput = document.getElementById('searchInput');
                const searchValue = searchInput ? searchInput.value.trim() : '';

                filteredTasks = filterByNormalizedSearch(tasks, searchValue, task => task.name, true);

                filteredTasks.sort((a, b) => {
                    if (a.completed && !b.completed) return 1;
                    if (!a.completed && b.completed) return -1;
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                const taskList = document.getElementById('taskList');

                if (viewMode === 'compact') {
                    const tasksToShow = filteredTasks.slice(0, totalLoadedTasks);
                    renderTasks(tasksToShow);
                    updateShowMoreButton();
                    document.getElementById('paginationControls').style.display = 'none';
                } else {
                    const totalPages = Math.ceil(filteredTasks.length / pageSize);

                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = totalPages;
                    }

                    const startIndex = (currentPage - 1) * pageSize;
                    const endIndex = Math.min(startIndex + pageSize, filteredTasks.length);

                    const tasksForCurrentPage = filteredTasks.slice(startIndex, endIndex);

                    updatePaginationInfo(filteredTasks.length, totalPages);
                    renderTasks(tasksForCurrentPage);

                    const showMoreBtn = document.getElementById('showMoreBtn');
                    if (showMoreBtn) showMoreBtn.style.display = 'none';
                }

                if (tasks.length === 0 && searchValue) {
                    taskList.innerHTML = `<p style="text-align: center; margin-top: 20px;">Nenhum cronograma encontrado para "<strong>${searchValue}</strong>". Tente outra pesquisa.</p>`;
                } else if (tasks.length === 0) {
                    taskList.innerHTML = '<p style="text-align: center; margin-top: 20px;">Nenhum cronograma encontrado. Crie um novo usando o formul√°rio acima.</p>';
                }
            };

            request.onerror = (event) => {
                console.error('Erro ao carregar cronogramas:', event.target.error);
                showStatusMessage('Erro ao carregar cronogramas', 'error');
            };
            // ===== REABRIR √öLTIMA TAREFA ATIVA =====
            if (expandedTasks.size > 0) {
                const lastExpandedId = Array.from(expandedTasks)[0];

                setTimeout(() => {
                    const taskElement = document.querySelector(`[data-taskid="${lastExpandedId}"]`)?.closest('.task-item');
                    if (taskElement && !taskElement.classList.contains('expanded')) {
                        const expandBtn = taskElement.querySelector('.expand-btn');
                        if (expandBtn) {
                            expandBtn.click();
                        }
                    }
                }, 200);
            }
        }

        function filterByNormalizedSearch(items, searchQuery, fieldAccessor, highlight = false) {
            const normalizeText = (text) => {
                return text
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase();
            };

            const escapeRegExp = (string) => {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            };

            const normalizedQuery = normalizeText(searchQuery.trim());
            if (!normalizedQuery) return items.map(item => ({ ...item, highlighted: fieldAccessor(item) }));

            const queryWords = normalizedQuery.split(/\s+/);

            return items
                .filter(item => {
                    const normalizedField = normalizeText(fieldAccessor(item));
                    return queryWords.every(word => normalizedField.includes(word));
                })
                .map(item => {
                    if (!highlight) return { ...item, highlighted: fieldAccessor(item) };

                    const originalText = fieldAccessor(item);
                    let highlightedText = originalText;

                    queryWords.forEach(word => {
                        const regex = new RegExp(`(${escapeRegExp(word)})`, 'gi');

                        highlightedText = highlightedText.replace(/([\w√Ä-√ø]+)/g, (match) => {
                            const normalizedMatch = normalizeText(match);
                            return queryWords.includes(normalizedMatch)
                                ? `<mark>${match}</mark>` : match;
                        });
                    });

                    return { ...item, highlighted: highlightedText };
                });
        }
        // ==================== SISTEMA DE COLAPSO DE N√çVEIS ====================

        // Adicione esta fun√ß√£o ANTES do renderTasks()
        function renderStepsWithCollapse(steps, taskId) {
            let html = '';

            steps.forEach((step, index) => {
                const level = step.level || 0;
                const hasChildren = index < steps.length - 1 && steps[index + 1].level > level;

                // IMPORTANTE: Ocultar todos os filhos por padr√£o (exceto n√≠vel 0)
                const isHidden = level > 0;

                // Calcular padding para n√≠veis > 5
                const paddingLeft = level > 5 ? 150 + (level - 5) * 30 : 0;
                const extraStyle = level > 5 ? `padding-left: ${paddingLeft}px; border-left: 3px solid #ccc;` : '';
                const hideStyle = isHidden ? 'display: none;' : '';

                // IMPORTANTE: √çcone come√ßa fechado (‚ñ∂) para itens com filhos
                const collapseIcon = hasChildren
                    ? `<span class="collapse-icon" onclick="toggleStepChildren(${taskId}, ${index}, event)" style="cursor: pointer; margin-right: 5px; user-select: none;">‚ñ∂</span>`
                    : '<span style="margin-right: 5px; opacity: 0; width: 16px; display: inline-block;">‚ñº</span>';

                html += `
            <div class="task-step ${step.completed ? 'completed' : ''}" 
                 data-level="${level}"
                 data-step-index="${index}"
                 data-has-children="${hasChildren}"
                 data-task-id="${taskId}"
                 style="${extraStyle}${hideStyle}">
                ${collapseIcon}
                <input type="checkbox" 
                       class="task-step-checkbox" 
                       data-taskid="${taskId}" 
                       data-stepindex="${index}" 
                       ${step.completed ? 'checked' : ''}>
                <div class="step-content">${step.text}</div>
            </div>
        `;
            });

            return html;
        }

        // Fun√ß√£o para colapsar/expandir filhos
        // SUBSTITUA a fun√ß√£o completa:
        function toggleStepChildren(taskId, stepIndex, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
            if (!taskElement) return;

            const steps = taskElement.querySelectorAll('.task-step');
            const clickedStep = steps[stepIndex];
            const clickedLevel = parseInt(clickedStep.getAttribute('data-level'));
            const icon = clickedStep.querySelector('.collapse-icon');
            const isCollapsed = icon.textContent === '‚ñ∂';

            if (isCollapsed) {
                // ===== OCULTAR IRM√ÉOS E TODOS OS SEUS DESCENDENTES =====
                steps.forEach((step, idx) => {
                    const stepLevel = parseInt(step.getAttribute('data-level'));

                    // √â irm√£o (mesmo n√≠vel, n√£o √© o clicado)
                    if (stepLevel === clickedLevel && idx !== stepIndex) {
                        // üî¥ OCULTAR O PR√ìPRIO IRM√ÉO
                        step.style.display = 'none';
                        const stepIcon = step.querySelector('.collapse-icon');
                        if (stepIcon) stepIcon.textContent = '‚ñ∂';

                        // üî¥ OCULTAR TODOS OS DESCENDENTES DO IRM√ÉO
                        for (let i = idx + 1; i < steps.length; i++) {
                            const childLevel = parseInt(steps[i].getAttribute('data-level'));
                            if (childLevel <= stepLevel) break;
                            steps[i].style.display = 'none';
                            const childIcon = steps[i].querySelector('.collapse-icon');
                            if (childIcon) childIcon.textContent = '‚ñ∂';
                        }
                    }
                });
                setTimeout(() => {
                    clickedStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // pequeno delay para o DOM atualizar antes de rolar
                    scrollAllVisibleStepsToEnd(taskId);
                }, 60);
            }

            // Atualizar √≠cone do item clicado
            icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';

            // Mostrar/ocultar filhos diretos (n√≠vel + 1)
            for (let i = stepIndex + 1; i < steps.length; i++) {
                const currentLevel = parseInt(steps[i].getAttribute('data-level'));
                if (currentLevel <= clickedLevel) break;

                if (currentLevel === clickedLevel + 1) {
                    if (isCollapsed) {
                        steps[i].style.display = 'flex';
                    } else {
                        steps[i].style.display = 'none';
                        const childIcon = steps[i].querySelector('.collapse-icon');
                        if (childIcon) childIcon.textContent = '‚ñ∂';

                        for (let j = i + 1; j < steps.length; j++) {
                            const grandchildLevel = parseInt(steps[j].getAttribute('data-level'));
                            if (grandchildLevel <= currentLevel) break;
                            steps[j].style.display = 'none';
                            const grandchildIcon = steps[j].querySelector('.collapse-icon');
                            if (grandchildIcon) grandchildIcon.textContent = '‚ñ∂';
                        }
                    }
                } else if (currentLevel > clickedLevel + 1 && !isCollapsed) {
                    steps[i].style.display = 'none';
                }
            }
            // No final da fun√ß√£o toggleStepChildren, antes de fechar a fun√ß√£o:
            if (isCollapsed) {
                // Verificar se os filhos diretos abertos s√£o pontos finais
                for (let i = stepIndex + 1; i < steps.length; i++) {
                    const currentLevel = parseInt(steps[i].getAttribute('data-level'));
                    if (currentLevel <= clickedLevel) break;
                    if (currentLevel === clickedLevel + 1) {
                        const hasChildren = steps[i].getAttribute('data-has-children') === 'true';
                        if (!hasChildren) {
                            steps[i].querySelector('.step-content')?.classList.add('step-final');
                        }
                    }
                }
            }
        }

        function expandToStep(taskId, stepIndex) {
            const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
            if (!taskElement) return;

            const steps = taskElement.querySelectorAll('.task-step');
            const targetStep = steps[stepIndex];
            const targetLevel = parseInt(targetStep.getAttribute('data-level'));

            // Expandir todos os pais at√© chegar no step desejado
            let currentLevel = targetLevel;
            while (currentLevel > 0) {
                for (let i = stepIndex - 1; i >= 0; i--) {
                    const stepLevel = parseInt(steps[i].getAttribute('data-level'));
                    if (stepLevel === currentLevel - 1) {
                        const icon = steps[i].querySelector('.collapse-icon');
                        if (icon && icon.textContent === '‚ñ∂') {
                            toggleStepChildren(taskId, i, null);
                        }
                        break;
                    }
                }
                currentLevel--;
            }

            // ===== OCULTAR TUDO AP√ìS O STEP ENCONTRADO =====
            for (let i = stepIndex + 1; i < steps.length; i++) {
                steps[i].style.display = 'none';
                const icon = steps[i].querySelector('.collapse-icon');
                if (icon) icon.textContent = '‚ñ∂';
            }

            targetStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function renderTasks(tasks, searchValue = '') {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';

            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="text-align: center; margin-bottom: 239px; margin-top: 135px;">Nenhum cronograma encontrado.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                const isExpanded = expandedTasks.has(task.id);
                taskElement.className = `task-item ${task.completed ? 'completed' : ''} ${isExpanded ? 'expanded' : 'collapsed'}`;

                const completedSteps = task.steps.filter(step => step.completed).length;
                const totalSteps = task.steps.length;
                const progressPercentage = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;

                taskElement.innerHTML = `
            <div class="task-content">
                ${(task.images && task.images.length > 0) || task.image ? `
                    <div class="task-image-container">
                        <div class="task-images-scroll ${task.images?.length === 1 ? 'single-image' : ''}" style="display: none;">
                            ${(task.images && task.images.length > 0)
                            ? task.images.map((img, index) => `
                                    <img src="${img}" alt="Imagem ${index + 1}" class="scroll-image">
                                `).join('')
                            : `<img src="${task.image}" alt="Imagem do cronograma" class="scroll-image">`}
                        </div>
                    </div>
                ` : ''}

                <div class="task-name">${task.highlighted || task.name}</div>

                <div class="task-progress">
                    <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                </div>
                <div class="task-info">
                    <small>Progresso: ${completedSteps}/${totalSteps} (${Math.round(progressPercentage)}%)</small>
                </div>

                <div class="task-steps-wrapper">
                    <div class="task-steps ${isExpanded ? '' : 'collapsed'}">
                        <!-- ADICIONE ESTAS LINHAS: -->
                <div class="expand-all-controls" style="margin: 10px 0; display: flex; gap: 10px;">
                    <button onclick="expandAllSteps(${task.id})" class="btn-small" style="font-size: 12px; padding: 5px 10px;">
                        ‚ñº Expandir Tudo
                    </button>
                    <button onclick="collapseAllSteps(${task.id})" class="btn-small" style="font-size: 12px; padding: 5px 10px;">
                        ‚ñ∂ Recolher Tudo
                    </button>
                </div>
                        ${renderStepsWithCollapse(task.steps, task.id)}
                    </div>
                </div>
                <div class="task-local-search">
                    <button class="step-voice-search-btn searchvoice" title="Pesquisar por voz">üéôÔ∏è</button>
                    <button class="clear-step-search-btn cuqui" title="Limpar pesquisa">‚úñ</button>
                    <button class="prev-match-btn ant" title="Anterior">‚óÄ</button>
                    <button class="next-match-btn prox" title="Pr√≥xima">‚ñ∂</button>
                    <input
                        type="text"
                        class="step-search-input cuqui0"
                        placeholder="Buscar Tarefa..."
                    />
                </div>
            </div>
            <div class="botoesExpandir">
                <button class="expand-btn ${isExpanded ? 'expanded' : ''}" data-taskid="${task.id}">
                    <span class="expand-icon">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
                    <span class="expand-text">${isExpanded ? 'Recolher' : `Expandir (${totalSteps} passos)`}</span>
                </button>
                <button class="toggle-image-btn colorir" data-taskid="${task.id}">
                    Mostrar imagens
                </button>
            </div>
            <div class="boxBonito">
                <div class="task-actions">
                    <button class="step-read-btn" data-taskid="${task.id}">
                        <span class="read-btn-text">‚ñ∂Ô∏è Executar</span>
                    </button>
                    <button class="edit-task-btn" data-taskid="${task.id}">‚úèÔ∏è Editar</button>
                    <button onclick="resetTaskSteps('${task.id}')" class="reset-btn">üîÑ Resetar</button>
                    <button class="read-task-btn" data-taskid="${task.id}">
                        <span class="read-btn-text">üîä Ler</span>
                    </button>
                    <button class="delete-task-btn danger" data-taskid="${task.id}">üóëÔ∏è Deletar</button>
                </div>
            </div>
        `;

                taskList.appendChild(taskElement);

                // Event listeners
                const clearBtn = taskElement.querySelector('.clear-step-search-btn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        clearStepSearch(taskElement);
                    });
                }

                const stepSearchInput = taskElement.querySelector('.step-search-input');
                if (stepSearchInput) {
                    stepSearchInput.addEventListener('input', (e) => {
                        focusStepBySearch(taskElement, e.target.value);
                    });
                }

                const voiceBtn = taskElement.querySelector('.step-voice-search-btn');
                if (voiceBtn && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const stepRecognition = new SpeechRecognition();

                    stepRecognition.lang = 'pt-BR';
                    stepRecognition.interimResults = false;

                    voiceBtn.addEventListener('click', () => {
                        stepRecognition.start();
                    });

                    stepRecognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        stepSearchInput.value = transcript;
                        stepSearchInput.dispatchEvent(new Event('input'));
                    };
                }

                // Bot√µes de navega√ß√£o entre matches
                const prevBtn = taskElement.querySelector('.prev-match-btn');
                const nextBtn = taskElement.querySelector('.next-match-btn');

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (currentSearchMatches.length === 0) return;
                        currentMatchIndex = (currentMatchIndex - 1 + currentSearchMatches.length) % currentSearchMatches.length;
                        focusOnCurrentMatch(taskElement);
                        updateSearchCounter(taskElement);
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (currentSearchMatches.length === 0) return;
                        currentMatchIndex = (currentMatchIndex + 1) % currentSearchMatches.length;
                        focusOnCurrentMatch(taskElement);
                        updateSearchCounter(taskElement);
                    });
                }

                const scrollImages = taskElement.querySelectorAll('.scroll-image');
                scrollImages.forEach((img, index) => {
                    img.addEventListener('click', () => {
                        modalImages = task.images && task.images.length > 0
                            ? task.images
                            : [task.image];

                        currentImageIndex = index;

                        const imageModal = document.getElementById('imageModal');
                        const modalImage = document.getElementById('modalImage');
                        modalImage.src = modalImages[currentImageIndex];
                        imageModal.style.display = 'block';
                    });
                });

                const checkboxes = taskElement.querySelectorAll('.task-step-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', toggleStepCompletion);
                });

                const taskSteps = taskElement.querySelectorAll('.task-step');
                taskSteps.forEach(taskStep => {
                    taskStep.addEventListener('click', handleTaskStepClick);
                });

                const editBtn = taskElement.querySelector('.edit-task-btn');
                const deleteBtn = taskElement.querySelector('.delete-task-btn');
                const readBtn = taskElement.querySelector('.read-task-btn');
                const stepReadBtn = taskElement.querySelector('.step-read-btn');
                const toggleImageBtn = taskElement.querySelector('.toggle-image-btn');

                if (toggleImageBtn) {
                    toggleImageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const imageContainer = taskElement.querySelector('.task-images-scroll');
                        if (!imageContainer) return;

                        const isVisible = imageContainer.style.display === 'flex';
                        imageContainer.style.display = isVisible ? 'none' : 'flex';
                        toggleImageBtn.textContent = isVisible ? 'Mostrar imagens' : 'Ocultar imagens';
                    });
                }

                editBtn.addEventListener('click', () => openEditModal(task.id));
                deleteBtn.addEventListener('click', () => deleteTask(task.id));
                readBtn.addEventListener('click', () => toggleReadTask(task.id));
                stepReadBtn.addEventListener('click', () => readAndCheckNextStep(task.id));

                const expandBtn = taskElement.querySelector('.expand-btn');
                expandBtn.addEventListener('click', (e) => toggleTaskExpansion(e, task.id));
            });
        }

        function toggleStepCompletion(event) {
            const taskId = parseInt(event.target.dataset.taskid);
            const stepIndex = parseInt(event.target.dataset.stepindex);
            const completed = event.target.checked;

            updateTaskProgressLocally(taskId, stepIndex, completed);

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(taskId);

            request.onsuccess = (event) => {
                const task = event.target.result;

                if (task && task.steps[stepIndex]) {
                    task.steps[stepIndex].completed = completed;
                    task.completed = task.steps.every(step => step.completed);

                    const updateRequest = store.put(task);

                    updateRequest.onsuccess = () => {
                        // Sucesso
                    };

                    updateRequest.onerror = (event) => {
                        console.error('Erro ao atualizar o passo:', event.target.error);
                        showStatusMessage('Erro ao atualizar o passo', 'error');
                        loadTasks();
                    };
                }
            };

            request.onerror = (event) => {
                console.error('Erro ao obter o cronograma:', event.target.error);
                showStatusMessage('Erro ao obter o cronograma', 'error');
                loadTasks();
            };
        }

        function handleTaskStepClick(event) {
            // Ignorar cliques no √≠cone de colapso
            if (event.target.classList.contains('collapse-icon')) {
                return;
            }

            // Ignorar cliques no checkbox
            if (event.target.type === 'checkbox') {
                return;
            }

            event.stopPropagation();
            event.preventDefault();

            const checkbox = event.currentTarget.querySelector('.task-step-checkbox');

            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                const changeEvent = new Event('change', { bubbles: false });
                checkbox.dispatchEvent(changeEvent);
            }
        }

        function updateTaskProgressLocally(taskId, stepIndex, completed) {
            const taskElement = document.querySelector(`[data-taskid="${taskId}"].edit-task-btn`).closest('.task-item');
            if (!taskElement) return;

            const stepCheckbox = taskElement.querySelector(`[data-stepindex="${stepIndex}"]`);
            const stepElement = stepCheckbox.closest('.task-step');

            if (completed) {
                stepElement.classList.add('completed');
            } else {
                stepElement.classList.remove('completed');
            }

            const allSteps = taskElement.querySelectorAll('.task-step-checkbox');
            const completedSteps = taskElement.querySelectorAll('.task-step-checkbox:checked');
            const totalSteps = allSteps.length;
            const completedCount = completedSteps.length;
            const progressPercentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

            const progressBar = taskElement.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
            }

            const progressInfo = taskElement.querySelector('.task-info small');
            if (progressInfo) {
                progressInfo.textContent = `Progresso: ${completedCount}/${totalSteps} (${Math.round(progressPercentage)}%)`;
            }

            if (progressPercentage === 100) {
                taskElement.classList.add('completed');
            } else {
                taskElement.classList.remove('completed');
            }
        }

        function closeAllOtherTasks(currentTaskId) {
            // Buscar todas as tarefas expandidas
            const allTaskItems = document.querySelectorAll('.task-item');

            allTaskItems.forEach(taskItem => {
                const editBtn = taskItem.querySelector('.edit-task-btn');
                if (!editBtn) return;

                const taskId = parseInt(editBtn.getAttribute('data-taskid'));

                // Se n√£o for a tarefa atual E estiver expandida
                if (taskId !== currentTaskId && taskItem.classList.contains('expanded')) {
                    const expandBtn = taskItem.querySelector('.expand-btn');
                    const taskSteps = taskItem.querySelector('.task-steps');
                    const expandIcon = expandBtn.querySelector('.expand-icon');
                    const expandText = expandBtn.querySelector('.expand-text');

                    // Limpar busca antes de fechar
                    clearStepSearch(taskItem);

                    // Fechar a tarefa
                    expandedTasks.delete(taskId);
                    taskItem.classList.add('collapsed');
                    taskItem.classList.remove('expanded');
                    taskSteps.classList.add('collapsed');
                    expandBtn.classList.remove('expanded');

                    expandIcon.textContent = '‚ñº';

                    const totalSteps = taskSteps.querySelectorAll('.task-step').length;
                    expandText.textContent = `Expandir (${totalSteps} passos)`;
                }
            });
        }

        function toggleTaskExpansion(event, taskId) {
            event.preventDefault();
            event.stopPropagation();

            const expandBtn = event.currentTarget;
            const taskElement = expandBtn.closest('.task-item');
            const taskSteps = taskElement.querySelector('.task-steps');
            const expandIcon = expandBtn.querySelector('.expand-icon');
            const expandText = expandBtn.querySelector('.expand-text');

            const isCurrentlyCollapsed = taskElement.classList.contains('collapsed');

            if (isCurrentlyCollapsed) {
                // ===== OCULTAR TODOS OS OUTROS TASK-ITEMS =====
                const allTaskItems = document.querySelectorAll('.task-item');
                allTaskItems.forEach(item => {
                    if (item !== taskElement) {
                        item.style.display = 'none';
                    }
                });
                // ===== FIM =====

                // Fechar todas as outras tarefas
                closeAllOtherTasks(taskId);

                // EXPANDINDO A TAREFA
                expandedTasks.clear();
                expandedTasks.add(taskId);

                taskElement.classList.remove('collapsed');
                taskElement.classList.add('expanded');
                taskSteps.classList.remove('collapsed');
                expandBtn.classList.add('expanded');

                expandIcon.textContent = '‚ñ≤';
                expandText.textContent = 'Recolher';

                // Recolher todos os steps (exceto n√≠vel 0) ao expandir
                setTimeout(() => {
                    collapseAllSteps(taskId);
                    focusPendingStep(taskElement);
                }, 50);

                // Scroll suave at√© a tarefa
                setTimeout(() => {
                    taskElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start',
                        inline: 'nearest'
                    });
                }, 100);

            } else {
                // ===== MOSTRAR TODOS OS TASK-ITEMS NOVAMENTE =====
                const allTaskItems = document.querySelectorAll('.task-item');
                allTaskItems.forEach(item => {
                    item.style.display = 'block';
                });
                // ===== FIM =====

                // RECOLHENDO A TAREFA
                clearStepSearch(taskElement);
                expandedTasks.delete(taskId);
                taskElement.classList.add('collapsed');
                taskElement.classList.remove('expanded');
                taskSteps.classList.add('collapsed');
                expandBtn.classList.remove('expanded');

                expandIcon.textContent = '‚ñº';

                const totalSteps = taskSteps.querySelectorAll('.task-step').length;
                expandText.textContent = `Expandir (${totalSteps} passos)`;
            }
        }

        // ==================== FUN√á√ïES DE BUSCA LOCAL ====================
        function focusStepBySearch(taskElement, searchValue) {
            const normalizeText = (text) => {
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            const steps = taskElement.querySelectorAll('.task-step');
            const normalizedSearch = normalizeText(searchValue.trim());

            if (!normalizedSearch) {
                clearStepSearch(taskElement);
                return;
            }

            // Limpar destaques anteriores
            steps.forEach(step => {
                step.classList.remove('step-focus');
                const content = step.querySelector('.step-content');
                if (content && content.dataset.original) {
                    content.innerHTML = content.dataset.original;
                }
            });

            currentSearchMatches = [];

            steps.forEach((step, stepIndex) => {
                const content = step.querySelector('.step-content');
                if (!content) return;

                const originalText = content.textContent;
                const normalizedText = normalizeText(originalText);

                if (normalizedText.includes(normalizedSearch)) {
                    if (!content.dataset.original) {
                        content.dataset.original = originalText;
                    }

                    let highlightedText = originalText;
                    const regex = new RegExp(`(${searchValue.split('').join('[√†√°√¢√£√§√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√µ√∂√π√∫√ª√º]*')})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');

                    content.innerHTML = highlightedText;
                    currentSearchMatches.push(step);

                    // IMPORTANTE: Expandir at√© este step (n√£o expandir tudo)
                    const taskId = step.getAttribute('data-task-id');
                    const stepIdx = parseInt(step.getAttribute('data-step-index'));
                    if (taskId && !isNaN(stepIdx)) {
                        expandToStep(taskId, stepIdx);
                    }
                }
            });

            if (currentSearchMatches.length === 0) return;

            currentMatchIndex = 0;
            focusOnCurrentMatch(taskElement);
            updateSearchCounter(taskElement);
        }

        // ==================== FUN√á√ÉO GEN√âRICA DE BUSCA (REUTILIZ√ÅVEL) ====================
        function performSearch(searchValue, config) {
            const normalizeText = (text) => {
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            const container = config.container;
            const isTextarea = container.tagName === 'TEXTAREA';

            if (!searchValue.trim()) {
                if (isTextarea) {
                    clearTextareaSearch(container);
                } else {
                    clearStepSearch(container);
                }
                return;
            }

            if (isTextarea) {
                // BUSCA EM TEXTAREA (MODAL)
                searchInTextarea(container, searchValue, normalizeText);
            } else {
                // BUSCA EM STEPS (TASKS)
                searchInSteps(container, searchValue, normalizeText, config);
            }
        }

        function searchInSteps(taskElement, searchValue, normalizeText, config) {
            const steps = taskElement.querySelectorAll(config.itemsSelector);
            const normalizedSearch = normalizeText(searchValue);

            steps.forEach(step => {
                step.classList.remove('step-focus');
                const content = step.querySelector(config.contentSelector);
                if (content && content.dataset.original) {
                    content.innerHTML = content.dataset.original;
                }
            });

            currentSearchMatches = [];
            steps.forEach((step, stepIndex) => {
                const content = step.querySelector(config.contentSelector);
                if (!content) return;

                const originalText = content.textContent;
                const normalizedText = normalizeText(originalText);

                if (normalizedText.includes(normalizedSearch)) {
                    if (!content.dataset.original) {
                        content.dataset.original = originalText;
                    }

                    let highlightedText = originalText;
                    const regex = new RegExp(`(${searchValue.split('').join('[√†√°√¢√£√§√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√µ√∂√π√∫√ª√º]*')})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');

                    content.innerHTML = highlightedText;
                    currentSearchMatches.push(step);
                }
            });

            if (currentSearchMatches.length === 0) return;

            currentMatchIndex = 0;
            focusOnCurrentMatch(taskElement);
            if (currentSearchMatches.length > 0) {
                // Expandir apenas at√© o primeiro resultado
                const firstMatch = currentSearchMatches[0];
                const taskId = firstMatch.getAttribute('data-task-id');
                const stepIdx = parseInt(firstMatch.getAttribute('data-step-index'));

                if (taskId && !isNaN(stepIdx)) {
                    expandToStep(taskId, stepIdx);
                }
            }
            if (config.onComplete) {
                config.onComplete(taskElement);
            }
        }

        function searchInTextarea(textarea, searchValue, normalizeText) {
            const previewDiv = document.getElementById('editModalPreview');

            if (!searchValue.trim()) {
                clearTextareaSearch(textarea);
                return;
            }

            // Mostrar preview e ocultar textarea
            textarea.style.display = 'none';
            previewDiv.style.display = 'block';

            const text = textarea.value;
            const normalizedSearch = normalizeText(searchValue);
            const normalizedText = normalizeText(text);

            // Dividir em linhas
            const lines = text.split('\n');
            const matches = [];

            lines.forEach((line, lineIndex) => {
                const normalizedLine = normalizeText(line);
                if (normalizedLine.includes(normalizedSearch)) {
                    matches.push({ lineIndex, line });
                }
            });

            if (matches.length === 0) {
                previewDiv.innerHTML = '<p style="color: #999;">Nenhuma ocorr√™ncia encontrada</p>';
                updateTextareaCounter(0, 0);
                return;
            }

            // Salvar matches
            window.textareaMatches = matches;
            window.textareaMatchIndex = 0;

            renderTextareaMatches(matches, searchValue, normalizeText);
            updateTextareaCounter(1, matches.length);
        }

        function renderTextareaMatches(matches, searchValue, normalizeText) {
            const previewDiv = document.getElementById('editModalPreview');
            let html = '';

            matches.forEach((match, index) => {
                const line = match.line;
                const normalizedLine = normalizeText(line);
                const normalizedSearch = normalizeText(searchValue);

                // Destacar a palavra encontrada
                let highlightedLine = line;
                const regex = new RegExp(`(${searchValue.split('').join('[√†√°√¢√£√§√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√µ√∂√π√∫√ª√º]*')})`, 'gi');
                highlightedLine = highlightedLine.replace(regex, '<mark>$1</mark>');

                const isActive = index === window.textareaMatchIndex;
                const className = isActive ? 'step-focus' : '';

                html += `
            <div class="task-step ${className}" data-match-index="${index}" data-line-index="${match.lineIndex}" style="cursor: pointer;">
                <div class="step-content">${highlightedLine}</div>
            </div>
        `;
            });

            previewDiv.innerHTML = html;

            // üî• ADICIONAR EVENT LISTENERS NOS ITEMS
            const items = previewDiv.querySelectorAll('.task-step');
            items.forEach(item => {
                item.addEventListener('click', () => {
                    const lineIndex = parseInt(item.dataset.lineIndex);
                    editTextareaLine(lineIndex, searchValue);
                });
            });

            // Focar no item ativo
            setTimeout(() => {
                const activeElement = previewDiv.querySelector('.step-focus');
                if (activeElement) {
                    activeElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 50);
        }

        function editTextareaLine(lineIndex, searchValue) {
            const textarea = document.getElementById('editTaskSteps');
            const previewDiv = document.getElementById('editModalPreview');

            if (!textarea) return;

            // Ocultar preview e mostrar textarea
            previewDiv.style.display = 'none';
            textarea.style.display = 'block';

            // Calcular posi√ß√£o do cursor na linha espec√≠fica
            const lines = textarea.value.split('\n');
            let position = 0;

            for (let i = 0; i < lineIndex; i++) {
                position += lines[i].length + 1; // +1 para o \n
            }

            // Se houver texto de busca, encontrar a palavra na linha
            if (searchValue) {
                const line = lines[lineIndex];
                const normalizeText = (text) => {
                    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                };

                const normalizedLine = normalizeText(line);
                const normalizedSearch = normalizeText(searchValue);

                // üî• CORRE√á√ÉO: Encontrar a posi√ß√£o real considerando acentos
                let wordPosition = -1;
                let realPosition = 0;

                for (let i = 0; i < line.length; i++) {
                    const substring = normalizeText(line.substring(i));
                    if (substring.startsWith(normalizedSearch)) {
                        wordPosition = i;
                        break;
                    }
                }

                if (wordPosition !== -1) {
                    position += wordPosition;

                    // üî• CALCULAR O TAMANHO REAL DA PALAVRA (pode ter acentos)
                    let realLength = 0;
                    let normalizedCount = 0;

                    for (let i = wordPosition; i < line.length && normalizedCount < normalizedSearch.length; i++) {
                        const char = line[i];
                        const normalizedChar = normalizeText(char);
                        if (normalizedChar) {
                            normalizedCount += normalizedChar.length;
                        }
                        realLength++;
                    }

                    // Selecionar a palavra encontrada
                    textarea.focus();
                    textarea.setSelectionRange(position, position + realLength);

                    // üî• SCROLL VERTICAL E HORIZONTAL
                    scrollToSelection(textarea, position, realLength);
                } else {
                    // Se n√£o encontrar, selecionar o in√≠cio da linha
                    textarea.focus();
                    textarea.setSelectionRange(position, position);
                    scrollToSelection(textarea, position, 0);
                }
            } else {
                // Sem busca, apenas focar na linha
                textarea.focus();
                textarea.setSelectionRange(position, position);
                scrollToSelection(textarea, position, 0);
            }

            // Limpar a busca
            const searchInput = document.getElementById('editModalSearch');
            const counter = document.getElementById('editModalSearchCounter');

            if (searchInput) searchInput.value = '';
            if (counter) counter.textContent = '';

            window.textareaMatches = [];
            window.textareaMatchIndex = 0;
        }

        // üî• NOVA FUN√á√ÉO PARA SCROLL PERFEITO
        function scrollToSelection(textarea, start, length) {
            // Scroll vertical
            const textBeforeSelection = textarea.value.substring(0, start);
            const lineNumber = textBeforeSelection.split('\n').length;
            const lineHeight = parseInt(getComputedStyle(textarea).lineHeight) || 20;

            // Centralizar verticalmente
            const targetScrollTop = Math.max(0, (lineNumber - 3) * lineHeight);
            textarea.scrollTop = targetScrollTop;

            // üî• SCROLL HORIZONTAL
            setTimeout(() => {
                // Criar elemento tempor√°rio para medir a largura do texto
                const measure = document.createElement('span');
                measure.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: pre;
            font-family: ${getComputedStyle(textarea).fontFamily};
            font-size: ${getComputedStyle(textarea).fontSize};
        `;

                // Pegar a linha atual
                const lines = textarea.value.split('\n');
                const currentLineIndex = lineNumber - 1;
                const currentLine = lines[currentLineIndex] || '';

                // Texto at√© a sele√ß√£o na linha atual
                const textBeforeInLine = textBeforeSelection.split('\n').pop() || '';

                measure.textContent = textBeforeInLine;
                document.body.appendChild(measure);

                const textWidth = measure.offsetWidth;
                document.body.removeChild(measure);

                // Scroll horizontal para mostrar a sele√ß√£o
                const textareaWidth = textarea.clientWidth;
                const padding = 50; // margem de seguran√ßa

                if (textWidth > textarea.scrollLeft + textareaWidth - padding) {
                    // Precisa rolar para direita
                    textarea.scrollLeft = textWidth - textareaWidth / 2;
                } else if (textWidth < textarea.scrollLeft + padding) {
                    // Precisa rolar para esquerda
                    textarea.scrollLeft = Math.max(0, textWidth - padding);
                }
            }, 10);
        }

        function nextTextareaMatch() {
            const searchInput = document.getElementById('editModalSearch');

            if (!window.textareaMatches || window.textareaMatches.length === 0) return;

            window.textareaMatchIndex = (window.textareaMatchIndex + 1) % window.textareaMatches.length;

            const normalizeText = (text) => {
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            renderTextareaMatches(window.textareaMatches, searchInput.value, normalizeText);
            updateTextareaCounter(window.textareaMatchIndex + 1, window.textareaMatches.length);
        }

        function prevTextareaMatch() {
            const searchInput = document.getElementById('editModalSearch');

            if (!window.textareaMatches || window.textareaMatches.length === 0) return;

            window.textareaMatchIndex = (window.textareaMatchIndex - 1 + window.textareaMatches.length) % window.textareaMatches.length;

            const normalizeText = (text) => {
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            renderTextareaMatches(window.textareaMatches, searchInput.value, normalizeText);
            updateTextareaCounter(window.textareaMatchIndex + 1, window.textareaMatches.length);
        }

        function updateTextareaCounter(current, total) {
            const counter = document.getElementById('editModalSearchCounter');
            if (counter) {
                counter.textContent = total > 0 ? `${current}/${total}` : '';
            }
        }

        function clearTextareaSearch(textarea) {
            const searchInput = document.getElementById('editModalSearch');
            const counter = document.getElementById('editModalSearchCounter');
            const previewDiv = document.getElementById('editModalPreview');

            if (searchInput) searchInput.value = '';
            if (counter) counter.textContent = '';

            // Ocultar preview e mostrar textarea
            if (previewDiv) previewDiv.style.display = 'none';
            if (textarea) textarea.style.display = 'block';

            window.textareaMatches = [];
            window.textareaMatchIndex = 0;
        }

        function focusOnCurrentMatch(taskElement) {
            if (currentSearchMatches.length === 0) return;

            currentSearchMatches.forEach(step => step.classList.remove('step-focus'));

            const currentStep = currentSearchMatches[currentMatchIndex];
            currentStep.classList.add('step-focus');

            currentStep.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        function updateSearchCounter(taskElement) {
            const searchInput = taskElement.querySelector('.step-search-input');
            if (!searchInput) return;

            const existingCounter = taskElement.querySelector('.search-counter');
            if (existingCounter) {
                existingCounter.remove();
            }

            if (currentSearchMatches.length > 0) {
                const counter = document.createElement('span');
                counter.className = 'search-counter';
                counter.textContent = `${currentMatchIndex + 1}/${currentSearchMatches.length}`;
                counter.style.cssText = 'margin-left: 0px; margin-right: 5px; color: #666; font-size: 12px;';
                searchInput.parentElement.appendChild(counter);
            }
        }

        function clearStepSearch(taskElement) {
            const input = taskElement.querySelector('.step-search-input');
            const steps = taskElement.querySelectorAll('.task-step');
            const counter = taskElement.querySelector('.search-counter');

            if (input) input.value = '';
            if (counter) counter.remove();

            steps.forEach(step => {
                step.classList.remove('step-focus');
                // N√ÉO REMOVER: step.style.display = ''; ‚Üê ESTA LINHA CAUSA O PROBLEMA

                const content = step.querySelector('.step-content');
                if (content && content.dataset.original) {
                    content.innerHTML = content.dataset.original;
                    delete content.dataset.original;
                }
            });

            currentSearchMatches = [];
            currentMatchIndex = 0;

            // IMPORTANTE: Recolher tudo ap√≥s limpar a busca
            const taskId = taskElement.querySelector('[data-taskid]')?.getAttribute('data-taskid');
            if (taskId) {
                setTimeout(() => {
                    collapseAllSteps(taskId);
                }, 100);
            }
        }

        // ==================== FUN√á√ïES DE PAGINA√á√ÉO ====================
        function updatePaginationInfo(totalItems, totalPages) {
            const pageInfo = document.getElementById('pageInfo');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const paginationControls = document.getElementById('paginationControls');

            if (pageInfo) {
                pageInfo.textContent = ` ${currentPage} de ${totalPages || 1}`;
            }

            if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;

            if (paginationControls) {
                paginationControls.style.display = totalPages <= 1 ? 'none' : 'flex';
            }
        }

        function updateShowMoreButton() {
            const showMoreBtn = document.getElementById('showMoreBtn');

            if (showMoreBtn) {
                if (viewMode === 'compact' && filteredTasks.length > totalLoadedTasks) {
                    showMoreBtn.style.display = 'block';
                } else {
                    showMoreBtn.style.display = 'none';
                }
            }
        }

        // ==================== FUN√á√ïES DE C√ÇMERA E IMAGENS ====================
        function checkCameraSupport() {
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }

        async function takePhoto() {
            if (!checkCameraSupport()) {
                alert('C√¢mera n√£o suportada neste navegador');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });

                showCameraModal(stream, false);
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
            }
        }

        async function takePhotoEdit() {
            if (!checkCameraSupport()) {
                alert('C√¢mera n√£o suportada neste navegador');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });

                showCameraModal(stream, true);
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
            }
        }

        function showCameraModal(stream, isEditMode) {
            currentStream = stream;

            const cameraModal = document.createElement('div');
            cameraModal.id = 'cameraModal';
            cameraModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100001;
    `;

            cameraModal.innerHTML = `
        <div style="text-align: center; color: white;">
            <video id="cameraVideo" autoplay style="max-width: 90%; max-height: 70%; border-radius: 10px;"></video>
            <br><br>
            <button id="captureBtn" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; margin: 10px; cursor: pointer;">
                üì∏ Capturar
            </button>
            <button id="switchCameraBtn" style="background: #2196F3; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; margin: 10px; cursor: pointer;">
                üîÑ Trocar C√¢mera
            </button>
            <button id="closeCameraBtn" style="background: #f44336; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; margin: 10px; cursor: pointer;">
                ‚ùå Fechar
            </button>
        </div>
    `;

            document.body.appendChild(cameraModal);

            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;

            document.getElementById('captureBtn').addEventListener('click', () => {
                captureImage(video, isEditMode);
                closeCameraModal();
            });

            document.getElementById('switchCameraBtn').addEventListener('click', () => {
                switchCamera(isEditMode);
            });

            document.getElementById('closeCameraBtn').addEventListener('click', closeCameraModal);
        }

        function captureImage(video, isEditMode) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            if (isEditMode) {
                editCapturedImagesData.push(imageData);
                showMultipleImagePreview(editCapturedImagesData, 'editImagePreview');
                updateImagesCount('editImagesCount', editCapturedImagesData.length);
            } else {
                capturedImagesData.push(imageData);
                showMultipleImagePreview(capturedImagesData, 'imagePreview');
                updateImagesCount('imagesCount', capturedImagesData.length);
            }
        }

        function showMultipleImagePreview(imagesArray, containerId) {
            const container = document.getElementById(containerId);

            if (imagesArray.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; flex-wrap: nowrap; gap: 10px; margin-top: 10px;">';

            imagesArray.forEach((imageData, index) => {
                html += `
            <div style="position: relative; display: inline-block;">
                <img src="${imageData}" 
                     alt="Imagem ${index + 1}" 
                     class="preview-image"
                     data-src="${imageData}"
                     style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                <button type="button" onclick="removeImageFromArray(${index}, '${containerId}')"
                        style="position: absolute; top: -2px; right: -2px; background: #ff000000; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">‚ùå</button>
            </div>
        `;
            });

            html += '</div>';
            container.innerHTML = html;

            setTimeout(() => {
                const previewImages = container.querySelectorAll('.preview-image');
                const imageModal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');

                previewImages.forEach(img => {
                    img.addEventListener('click', () => {
                        if (imageModal && modalImage) {
                            modalImage.src = img.dataset.src;
                            imageModal.style.display = 'block';
                        }
                    });
                });
            }, 0);
        }

        function removeImageFromArray(index, containerId) {
            if (containerId === 'editImagePreview') {
                editCapturedImagesData.splice(index, 1);
                showMultipleImagePreview(editCapturedImagesData, 'editImagePreview');
                updateImagesCount('editImagesCount', editCapturedImagesData.length);
            } else {
                capturedImagesData.splice(index, 1);
                showMultipleImagePreview(capturedImagesData, 'imagePreview');
                updateImagesCount('imagesCount', capturedImagesData.length);
            }
        }

        function updateImagesCount(counterId, count) {
            const counter = document.getElementById(counterId);
            if (counter) {
                counter.textContent = count > 0 ? `${count} imagem(ns) selecionada(s)` : '';
            }
        }

        function closeCameraModal() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            const modal = document.getElementById('cameraModal');
            if (modal) {
                modal.remove();
            }
        }

        async function switchCamera(isEditMode) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode }
                });

                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                currentStream = stream;

                const switchBtn = document.getElementById('switchCameraBtn');
                switchBtn.textContent = currentFacingMode === 'environment' ? 'ü§≥ C√¢mera Frontal' : 'üì∑ C√¢mera Traseira';

            } catch (error) {
                console.error('Erro ao trocar c√¢mera:', error);
            }
        }

        function handleImageUpload(event) {
            const files = event.target.files;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedImagesData.push(e.target.result);
                    showMultipleImagePreview(capturedImagesData, 'imagePreview');
                    updateImagesCount('imagesCount', capturedImagesData.length);
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        function handleEditImageUpload(event) {
            const files = event.target.files;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editCapturedImagesData.push(e.target.result);
                    showMultipleImagePreview(editCapturedImagesData, 'editImagePreview');
                    updateImagesCount('editImagesCount', editCapturedImagesData.length);
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        // ==================== FUN√á√ïES AUXILIARES ====================
        function showStatusMessage(message, type = 'success') {
            const statusMessage = document.getElementById('statusMessage');
            if (!statusMessage) return;

            statusMessage.textContent = message;
            statusMessage.className = 'status-message';

            if (type === 'error') {
                statusMessage.style.backgroundColor = '#f8d7da';
                statusMessage.style.color = '#721c24';
            } else {
                statusMessage.style.backgroundColor = '#d4edda';
                statusMessage.style.color = '#155724';
            }

            setTimeout(() => {
                statusMessage.classList.add('show');
            }, 10);

            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        function setupModalCloseOnOutsideClick() {
            const taskModal = document.getElementById('taskModal');
            if (taskModal) {
                taskModal.addEventListener('click', (e) => {
                    if (e.target === taskModal) {
                        closeModal();
                    }
                });
            }
        }

        // ==================== NAVEGA√á√ÉO DE IMAGENS NO MODAL ====================
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % modalImages.length;
            const modalImage = document.getElementById('modalImage');
            if (modalImage) {
                modalImage.src = modalImages[currentImageIndex];
            }
        }

        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + modalImages.length) % modalImages.length;
            const modalImage = document.getElementById('modalImage');
            if (modalImage) {
                modalImage.src = modalImages[currentImageIndex];
            }
        }

        // Expandir todos os n√≠veis
        function expandAllSteps(taskId) {
            const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
            if (!taskElement) return;

            const steps = taskElement.querySelectorAll('.task-step');

            steps.forEach(step => {
                step.style.display = 'flex';
                const icon = step.querySelector('.collapse-icon');
                if (icon && step.getAttribute('data-has-children') === 'true') {
                    icon.textContent = '‚ñº';
                }
            });
            setTimeout(() => {
                scrollAllVisibleStepsToEnd(taskId);
            }, 60);
        }

        // Recolher todos os n√≠veis (exceto n√≠vel 0)
        function collapseAllSteps(taskId) {
            const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
            if (!taskElement) return;

            const steps = taskElement.querySelectorAll('.task-step');

            steps.forEach((step, index) => {
                const level = parseInt(step.getAttribute('data-level'));
                const icon = step.querySelector('.collapse-icon');

                if (level > 0) {
                    step.style.display = 'none';
                }

                if (icon && step.getAttribute('data-has-children') === 'true') {
                    icon.textContent = '‚ñ∂';
                }
            });
        }
        // ==================== SCROLL HORIZONTAL PARA TODOS OS STEPS VIS√çVEIS ====================
function scrollAllVisibleStepsToEnd(taskId) {
    const taskElement = document.querySelector(`[data-taskid="${taskId}"]`).closest('.task-item');
    if (!taskElement) return;

    const wrapper = taskElement.querySelector('.task-steps-wrapper');
    const stepsContainer = taskElement.querySelector('.task-steps'); // container vertical
    const steps = taskElement.querySelectorAll('.task-step');

    if (!wrapper) return;

    // ===== HORIZONTAL ORIGINAL =====
    setTimeout(() => {
        wrapper.scrollLeft = wrapper.scrollWidth;
    }, 60);

    steps.forEach(step => {
        if (step.style.display === 'none') return;

        const content = step.querySelector('.step-content');
        if (!content) return;

        const stepRect = step.getBoundingClientRect();
        const wrapperRect = wrapper.getBoundingClientRect();

        if (stepRect.right > wrapperRect.right) {
            step.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'end' });
        }
    });

    // ===== VERTICAL SUAVE =====
    // Executa no pr√≥ximo ciclo de renderiza√ß√£o para n√£o conflitar com o horizontal
    if (stepsContainer) {
        requestAnimationFrame(() => {
            stepsContainer.scrollTo({
                top: stepsContainer.scrollHeight,
                behavior: 'smooth'
            });
        });
    }
}



        // ==================== BOT√ïES VISUAIS DE N√çVEL ====================

        function _getLineRange(textarea) {
            const start = textarea.selectionStart;
            const value = textarea.value;
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEndRaw = value.indexOf('\n', start);
            const lineEnd = lineEndRaw === -1 ? value.length : lineEndRaw;
            return { value, lineStart, lineEnd };
        }

        function _applyLineChange(textarea, lineStart, lineEnd, newLine) {
            const value = textarea.value;
            const before = value.substring(0, lineStart);
            const after = value.substring(lineEnd);
            textarea.value = before + newLine + after;
            // Mant√©m cursor no final da linha modificada
            const newPos = lineStart + newLine.length;
            textarea.selectionStart = textarea.selectionEnd = newPos;
            textarea.focus();
            // Atualiza indicador de n√≠vel
            updateLevelIndicator(textarea.id);
        }

        function getCurrentLineLevel(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return 0;
            const { value, lineStart, lineEnd } = _getLineRange(textarea);
            const line = value.substring(lineStart, lineEnd);
            const match = line.match(/^( *)/);
            return Math.floor((match ? match[1].length : 0) / 2);
        }

        function updateLevelIndicator(textareaId) {
            const level = getCurrentLineLevel(textareaId);
            const indicator = document.getElementById(textareaId + '_levelIndicator');
            if (indicator) {
                const labels = ['Raiz', 'Sub', 'Sub-sub', 'Detalhe', 'N√≠vel 4', 'N√≠vel 5'];
                const label = labels[level] || 'N√≠vel ' + level;
                indicator.textContent = label + ' (' + level + ')';

                // Mudar cor conforme o n√≠vel
                const cores = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#607D8B', '#795548'];
                indicator.style.background = cores[level] || '#607D8B';
                indicator.style.color = 'white';
            }
        }

        // Define o n√≠vel exato da linha atual
        function setLineLevel(textareaId, level) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            const { value, lineStart, lineEnd } = _getLineRange(textarea);
            const currentLine = value.substring(lineStart, lineEnd);
            const text = currentLine.trimStart(); // remove indenta√ß√£o existente
            const newLine = '  '.repeat(Math.max(0, level)) + text;
            _applyLineChange(textarea, lineStart, lineEnd, newLine);
        }

        // Aumenta o n√≠vel da linha atual em +1
        function increaseLineLevel(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            const { value, lineStart, lineEnd } = _getLineRange(textarea);
            const currentLine = value.substring(lineStart, lineEnd);
            const newLine = '  ' + currentLine; // adiciona 2 espa√ßos no in√≠cio
            _applyLineChange(textarea, lineStart, lineEnd, newLine);
        }

        // Diminui o n√≠vel da linha atual em -1 (m√≠nimo 0)
        function decreaseLineLevel(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            const { value, lineStart, lineEnd } = _getLineRange(textarea);
            const currentLine = value.substring(lineStart, lineEnd);
            // Remove at√© 2 espa√ßos do in√≠cio
            const newLine = currentLine.replace(/^ {1,2}/, '');
            _applyLineChange(textarea, lineStart, lineEnd, newLine);
        }

        // ==================== DOM CONTENT LOADED ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Aplica√ß√£o inicializada');

            // Event listeners - Imagens
            const taskImageInput = document.getElementById('taskImage');
            const cameraBtn = document.getElementById('cameraBtn');
            const galleryBtn = document.getElementById('galleryBtn');
            const editTaskImageInput = document.getElementById('editTaskImage');
            const editCameraBtn = document.getElementById('editCameraBtn');
            const editGalleryBtn = document.getElementById('editGalleryBtn');

            if (taskImageInput) taskImageInput.addEventListener('change', handleImageUpload);
            if (cameraBtn) cameraBtn.addEventListener('click', takePhoto);
            if (galleryBtn) galleryBtn.addEventListener('click', () => taskImageInput.click());
            if (editTaskImageInput) editTaskImageInput.addEventListener('change', handleEditImageUpload);
            if (editCameraBtn) editCameraBtn.addEventListener('click', takePhotoEdit);
            if (editGalleryBtn) editGalleryBtn.addEventListener('click', () => editTaskImageInput.click());

            // Event listeners - Busca
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');

            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchValue = this.value.trim();
                    if (clearSearchBtn) clearSearchBtn.style.display = searchValue ? 'block' : 'none';
                    currentPage = 1;
                    totalLoadedTasks = viewMode === 'compact' ? 2 : filteredTasks.length;
                    loadTasks();
                });
            }

            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function () {
                    if (searchInput) searchInput.value = '';
                    clearSearchBtn.style.display = 'none';
                    currentPage = 1;
                    totalLoadedTasks = viewMode === 'compact' ? 2 : filteredTasks.length;
                    loadTasks();
                });
            }

            // Event listeners - Pagina√ß√£o
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const viewModeSelect = document.getElementById('viewModeSelect');
            const showMoreBtn = document.getElementById('showMoreBtn');

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function () {
                    if (currentPage > 1) {
                        currentPage--;
                        loadTasks();
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function () {
                    const totalPages = Math.ceil(filteredTasks.length / pageSize);
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadTasks();
                    }
                });
            }

            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function () {
                    pageSize = parseInt(this.value);
                    currentPage = 1;
                    loadTasks();
                });
            }

            if (viewModeSelect) {
                viewModeSelect.addEventListener('change', function () {
                    viewMode = this.value;
                    currentPage = 1;
                    totalLoadedTasks = viewMode === 'compact' ? 2 : filteredTasks.length;
                    const paginationControls = document.getElementById('paginationControls');
                    if (paginationControls) {
                        paginationControls.style.display = viewMode === 'all' ? 'flex' : 'none';
                    }
                    loadTasks();
                });
            }

            if (showMoreBtn) {
                showMoreBtn.addEventListener('click', function () {
                    totalLoadedTasks += 2;
                    if (totalLoadedTasks >= filteredTasks.length) {
                        totalLoadedTasks = filteredTasks.length;
                        this.style.display = 'none';
                    }
                    loadTasks(); // ‚Üê MUDAN√áA: usar loadTasks() ao inv√©s de renderTasks()
                });
            }

            // Event listeners - Tarefas
            const createTaskBtn = document.getElementById('createTaskBtn');
            const resetBtn = document.getElementById('resetGuideBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importInput = document.getElementById('importInput');
            const importBtn = document.getElementById('importBtn');
            const modalCloseBtn = document.querySelector('.modal-close');
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            const audioBtn = document.getElementById('audioBtn');
            const editAudioBtn = document.getElementById('editAudioBtn');

            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', () => {
                    const container = document.querySelector('.container');
                    const toggleBtn = document.getElementById('toggleContainerBtn');
                    const viewModeBar = document.querySelector('.mostraEmodos'); // üëà ADICIONE
                    if (viewModeBar) viewModeBar.style.display = 'none'; // üëà ADICIONE

                    if (resetBtn) resetBtn.style.display = 'inline-block';

                    if (container && container.style.display === 'none') {
                        // ===== OCULTAR TODAS AS TAREFAS =====
                        const allTaskItems = document.querySelectorAll('.task-item');
                        allTaskItems.forEach(item => {
                            item.style.display = 'none';
                        });
                        // ===== FIM =====

                        container.style.display = 'block';
                        if (toggleBtn) {
                            toggleBtn.style.display = 'inline-block';
                            toggleBtn.textContent = 'Ocultar Guia';
                        }
                        return;
                    }
                    createTask();
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    const taskNameInput = document.getElementById('taskName');
                    const taskStepsInput = document.getElementById('taskSteps');

                    if (taskNameInput) taskNameInput.value = '';
                    if (taskStepsInput) taskStepsInput.value = '';
                    if (taskImageInput) taskImageInput.value = '';
                    isFirstAudioInput = true;
                });
            }

            if (exportBtn) exportBtn.addEventListener('click', exportTasks);
            if (importInput) importInput.addEventListener('change', importTasks);
            if (importBtn) importBtn.addEventListener('click', () => importInput.click());
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
            if (saveTaskBtn) saveTaskBtn.addEventListener('click', saveTaskChanges);
            if (audioBtn) audioBtn.addEventListener('click', toggleAudioRecording);
            if (editAudioBtn) editAudioBtn.addEventListener('click', toggleEditModalAudioRecording);

            // Event listeners - Pesquisa por voz
            const voiceSearchBtn = document.getElementById('voiceSearchBtn');
            const statusMessage = document.getElementById('statusMessage');

            if (voiceSearchBtn && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const voiceRecognition = new SpeechRecognition();
                voiceRecognition.lang = 'pt-BR';
                voiceRecognition.interimResults = false;
                voiceRecognition.maxAlternatives = 1;

                voiceSearchBtn.addEventListener('click', () => {
                    voiceRecognition.start();
                    if (statusMessage) statusMessage.innerText = 'Ouvindo...';
                });

                voiceRecognition.addEventListener('result', (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (searchInput) searchInput.value = transcript;
                    if (searchInput) searchInput.dispatchEvent(new Event('input'));
                    if (statusMessage) statusMessage.innerText = `Voc√™ disse: "${transcript}"`;
                });

                voiceRecognition.addEventListener('end', () => {
                    if (statusMessage) statusMessage.innerText = '';
                });

                voiceRecognition.addEventListener('error', (e) => {
                    if (statusMessage) statusMessage.innerText = 'Erro ao reconhecer voz. Tente novamente.';
                });
            } else if (voiceSearchBtn) {
                voiceSearchBtn.disabled = true;
                voiceSearchBtn.title = 'Seu navegador n√£o suporta pesquisa por voz.';
            }

            // Event listeners - Toggle Container
            const toggleBtn = document.getElementById('toggleContainerBtn');
            const container = document.querySelector('.container');

            if (toggleBtn && container) {
                toggleBtn.addEventListener('click', () => {
                    container.style.display = 'none';
                    toggleBtn.style.display = 'none';
                    if (resetBtn) resetBtn.style.display = 'none';

                    const viewModeBar = document.querySelector('.mostraEmodos'); // üëà ADICIONE
                    if (viewModeBar) viewModeBar.style.display = 'block'; // üëà ADICIONE

                    // ===== MOSTRAR TODAS AS TAREFAS NOVAMENTE =====
                    const allTaskItems = document.querySelectorAll('.task-item');
                    allTaskItems.forEach(item => {
                        item.style.display = 'block';
                    });
                    // ===== FIM =====
                });
            }

            // Event listeners - Modal de imagem
            const imageModal = document.getElementById('imageModal');
            const closeModalBtn = imageModal ? imageModal.querySelector('.close-modal') : null;
            const prevArrow = imageModal ? imageModal.querySelector('.nav-arrow.left') : null;
            const nextArrow = imageModal ? imageModal.querySelector('.nav-arrow.right') : null;
            const modalImage = document.getElementById('modalImage');

            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    if (imageModal) imageModal.style.display = 'none';
                });
            }

            if (imageModal) {
                imageModal.addEventListener('click', (e) => {
                    if (e.target === imageModal) {
                        imageModal.style.display = 'none';
                    }
                });
            }

            if (prevArrow) {
                prevArrow.addEventListener('click', e => {
                    e.stopPropagation();
                    prevImage();
                });
            }

            if (nextArrow) {
                nextArrow.addEventListener('click', e => {
                    e.stopPropagation();
                    nextImage();
                });
            }

            // Atualizar indicador de n√≠vel quando cursor mudar de linha
            const stepsInputs = ['taskSteps', 'editTaskSteps'];
            stepsInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('keyup', () => updateLevelIndicator(id));
                    el.addEventListener('click', () => updateLevelIndicator(id));
                    el.addEventListener('input', () => updateLevelIndicator(id));
                }
            });

            // Navega√ß√£o por teclado
            document.addEventListener('keydown', e => {
                if (!imageModal || imageModal.style.display !== 'block') return;

                if (e.key === 'ArrowRight') nextImage();
                if (e.key === 'ArrowLeft') prevImage();
                if (e.key === 'Escape') imageModal.style.display = 'none';
            });

            // Navega√ß√£o por swipe (mobile)
            if (modalImage) {
                let startX = 0;

                modalImage.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                });

                modalImage.addEventListener('touchend', e => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = startX - endX;

                    if (Math.abs(diff) > 50) {
                        if (diff > 0) {
                            nextImage();
                        } else {
                            prevImage();
                        }
                    }
                });
            }

            // Resize handle para textarea (mobile)
            const textarea = document.getElementById('editTaskSteps');
            const handle = document.getElementById('resizeHandle');

            if (textarea && handle) {
                let startY = 0;
                let startHeight = 0;

                handle.addEventListener('touchstart', e => {
                    e.preventDefault();
                    startY = e.touches[0].clientY;
                    startHeight = textarea.offsetHeight;
                }, { passive: false });

                handle.addEventListener('touchmove', e => {
                    e.preventDefault();
                    const delta = e.touches[0].clientY - startY;
                    textarea.style.height = Math.max(60, startHeight + delta) + 'px';
                }, { passive: false });
            }

            // Inicializa√ß√£o
            if (container) container.style.display = 'none';
            if (toggleBtn) toggleBtn.textContent = 'Mostrar Guia';

            if (viewMode === 'compact' && pageSizeSelect) {
                pageSizeSelect.value = '2';
                pageSize = 2;
            }

            if (viewModeSelect) viewMode = viewModeSelect.value;

            updateShowMoreButton();
            initSpeechRecognition();
            setupModalCloseOnOutsideClick();

            if (!checkSpeechSynthesisSupport()) {
                console.warn('Bot√µes de leitura podem n√£o funcionar corretamente');
            }

            // Adicionar CSS para preview do modal
            const style = document.createElement('style');
            style.textContent = `
                    #editModalPreview .task-step {
                        padding: 10px;
                        margin: 5px 0;
                        border-left: 3px solid transparent;
                        transition: all 0.3s ease;
                        cursor: pointer; /* üî• Mostrar que √© clic√°vel */
                    }
                    
                    #editModalPreview .task-step:hover {
                        background-color: #f0f0f0; /* üî• Efeito hover */
                    }
                    
                    #editModalPreview .task-step.step-focus {
                        background-color: #fff3cd;
                        border-left-color: #ffc107;
                    }
                    
                    #editModalPreview .step-content mark {
                        background-color: #ffeb3b;
                        padding: 2px 4px;
                        border-radius: 3px;
                    }
                `;
            document.head.appendChild(style);

            console.log('Dispositivo detectado:', isMobileDevice() ? 'Mobile' : 'Desktop');
            console.log('Pausa ap√≥s t√≠tulo:', PAUSE_AFTER_TITLE + 'ms');
            console.log('Pausa entre steps:', PAUSE_BETWEEN_STEPS + 'ms');
            // ===== ATALHOS DE TECLADO PARA MARCADORES =====
            const taskStepsInput = document.getElementById('taskSteps');
            const editTaskStepsInput = document.getElementById('editTaskSteps');

            if (taskStepsInput) {
                taskStepsInput.addEventListener('keydown', function (e) {
                    // Tab: inserir 2 espa√ßos
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 2;
                        return;
                    }

                    // Ctrl + / : inserir barra
                    if (e.ctrlKey && e.key === '/') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '/');
                        return;
                    }

                    // Ctrl + > : inserir seta
                    if (e.ctrlKey && e.key === '.') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '>');
                        return;
                    }

                    // Ctrl + - : inserir tra√ßo
                    if (e.ctrlKey && e.key === '-') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '-');
                        return;
                    }
                });
            }

            if (editTaskStepsInput) {
                editTaskStepsInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 2;
                        return;
                    }

                    if (e.ctrlKey && e.key === '/') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '/');
                        return;
                    }

                    if (e.ctrlKey && e.key === '.') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '>');
                        return;
                    }

                    if (e.ctrlKey && e.key === '-') {
                        e.preventDefault();
                        insertMarkerAtCursor(this, '-');
                        return;
                    }
                });
            }
        });
        // Fun√ß√£o auxiliar para inserir marcador
        function insertMarkerAtCursor(textarea, marker) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            // Encontrar in√≠cio da linha
            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const lineEnd = value.indexOf('\n', start);
            const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

            // Pegar linha atual
            const currentLine = value.substring(lineStart, actualLineEnd);

            // Verificar marcadores existentes
            const markerRegex = new RegExp(`^(\\${marker}+)\\s*(.*)$`);
            const match = currentLine.match(markerRegex);

            if (match) {
                // Adicionar mais um marcador
                const existingMarkers = match[1];
                const restOfLine = match[2];
                const newMarkers = existingMarkers + marker + ' ';
                const newLine = newMarkers + restOfLine;

                textarea.value = value.substring(0, lineStart) + newLine + value.substring(actualLineEnd);

                // Cursor no final dos marcadores
                textarea.selectionStart = textarea.selectionEnd = lineStart + newMarkers.length;
            } else {
                // Adicionar primeiro marcador
                const newMarker = marker + ' ';
                textarea.value = value.substring(0, lineStart) + newMarker + currentLine + value.substring(actualLineEnd);

                textarea.selectionStart = textarea.selectionEnd = lineStart + newMarker.length;
            }
        }

        // ==================== LIMPEZA AO SAIR ====================
        window.addEventListener('beforeunload', () => {
            stopAudioSequence();
        });

        window.addEventListener('pagehide', stopAudioSequence);
    </script>


</body>



</html>